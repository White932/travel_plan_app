<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>東京旅遊助手 Ultimate Precision</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --theme-color: #FF4757;
            --glass-blur: 20px;
            --glass-opacity: 0.85;
            --glass-saturation: 180%;
            --card-border: rgba(255, 255, 255, 0.5);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            overscroll-behavior-y: contain; 
            user-select: none;
        }
        
        body.scroll-locked {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        [v-cloak] { display: none; }
        
        .app-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center; z-index: -1;
            transition: background-image 0.5s ease;
        }
        .app-noise {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuNjUiIG51bU9jdGF2ZXM9IjMiIHN0aXRjaFRpbGVzPSJzdGl0Y2giLz48L2ZpbHRlcj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWx0ZXI9InVybCgjbm9pc2UpIiBvcGFjaXR5PSIwLjAzIi8+PC9zdmc+');
            pointer-events: none; z-index: -1; opacity: 0.6;
        }
        .app-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.2), rgba(255,255,255,0.8));
            transition: all 0.3s ease;
        }

        .app-container {
            display: flex; flex-direction: column; height: 100dvh; width: 100%; margin: 0 auto;
            position: relative; overflow: hidden;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 600px; margin: 20px auto; height: calc(100vh - 40px);
                border-radius: 24px; 
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                border: 1px solid rgba(255,255,255,0.4);
            }
        }

        .refresh-loader {
            position: absolute; top: 10px; left: 0; width: 100%;
            display: flex; justify-content: center; align-items: center;
            z-index: 50; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        .refresh-loader.visible { opacity: 1; }

        .text-primary { color: var(--theme-color) !important; }
        .bg-primary { background-color: var(--theme-color) !important; }
        .border-primary { border-color: var(--theme-color) !important; }
        .ring-primary { --tw-ring-color: var(--theme-color) !important; }
        .hover\:text-primary:hover { color: var(--theme-color) !important; }
        .hover\:bg-primary:hover { background-color: var(--theme-color) !important; }

        input[type="date"] { background: transparent; border: none; color: inherit; font-family: inherit; font-size: inherit; font-weight: bold; outline: none; padding: 0; cursor: pointer; min-width: 130px; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .weather-date-input::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.8; cursor: pointer; }
        .normal-date-input::-webkit-calendar-picker-indicator { filter: invert(0.4); cursor: pointer; }

        .glass-card {
            background: linear-gradient(135deg, rgba(255,255,255, var(--glass-opacity)), rgba(255,255,255, calc(var(--glass-opacity) - 0.2)));
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.8);
            border-left: 1px solid rgba(255, 255, 255, 0.8);
            transform: translateZ(0); 
            will-change: transform, backdrop-filter;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .glass-card-interactive { cursor: pointer; }
        .glass-card-interactive:active { transform: scale(0.98); }

        .weather-gradient-sunny { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        .weather-gradient-cloudy { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
        .weather-gradient-rainy { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
        .weather-gradient-gray { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }

        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin-fast { animation: spin 0.8s linear infinite; }
        
        input[type="color"] { -webkit-appearance: none; border: none; width: 32px; height: 32px; padding: 0; overflow: hidden; border-radius: 50%; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .note-custom { border-left-width: 4px; border-left-style: solid; }

        .header-section {
            flex: none;
            z-index: 30;
            position: relative;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        /* === 主內容捲動優化 (Main Content Scroll Optimization) === */
        .main-content {
            flex: 1;
            overflow-y: auto;
            /* 開啟 iOS 原生慣性捲動 */
            -webkit-overflow-scrolling: touch; 
            padding: 1.5rem 1rem 6rem 1rem; 
            z-index: 10;
            overscroll-behavior-y: contain;
            /* 確保滑動事件能正確傳遞 */
            touch-action: pan-y; 
        }

        .timeline-line {
            position: absolute; left: 23px; top: 0; bottom: 0;
            width: 2px; background-color: #e5e7eb; z-index: 0;
        }
        
        .hotel-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.2rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2rem;
        }

        .shop-img-container {
            width: 100%; padding-top: 100%; position: relative;
            overflow: hidden; border-radius: 16px; background-color: #f3f4f6;
        }
        .shop-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transition: transform 0.3s ease;
        }
        .shop-card:hover .shop-img { transform: scale(1.05); }
        .shop-bought-mask {
            position: absolute; inset: 0;
            background: rgba(16, 185, 129, 0.2);
            backdrop-filter: grayscale(100%);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .shop-card.bought .shop-bought-mask { opacity: 1; }
        .shop-card.bought .shop-img { filter: grayscale(100%); }

        /* === 列表動畫優化 (Refined Animations) === */
        .list-move {
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .list-enter-active,
        .list-leave-active {
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .list-enter-from,
        .list-leave-to {
            opacity: 0;
            transform: translateY(15px);
        }
        .list-leave-active {
            position: absolute; 
            width: 100%;
        }

        .is-being-dragged { opacity: 0.3; filter: grayscale(100%); transform: scale(0.95); transition: all 0.2s; }

        .ghost-card-container, .ghost-day-container {
            position: fixed; z-index: 9999; pointer-events: none;
            width: calc(100% - 3rem); max-width: 550px;
            transform-origin: center center;
            animation: lift-up 0.2s forwards; touch-action: none;
        }
        
        .ghost-day-container {
            width: calc(100% - 3rem);
            max-width: 340px; /* Match modal width roughly */
        }
        
        @keyframes lift-up {
            0% { transform: scale(1) rotate(0deg); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
            100% { transform: scale(1.03) rotate(2deg); box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        }

        /* === 天數選擇器優化 (Day Selector Optimization) === */
        .day-selector-container {
            display: flex;
            overflow-x: auto; /* 啟用原生橫向捲動 */
            gap: 0.75rem;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            /* 關鍵：啟用 iOS 慣性捲動，隨時可滑 */
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none; /* Firefox 隱藏捲軸 */
            -ms-overflow-style: none; /* IE/Edge 隱藏捲軸 */
            touch-action: pan-x; /* 告訴瀏覽器這裡主要處理橫向滑動 */
            cursor: grab;
        }
        .day-selector-container::-webkit-scrollbar { 
            display: none; /* Chrome/Safari 隱藏捲軸 */
        }
        .day-selector-container:active {
            cursor: grabbing;
        }
        
        .gap-nav-hidden { opacity: 0; pointer-events: none; height: 0; margin: 0; overflow: hidden; transition: all 0.2s; }
        
        .draggable-item-container { touch-action: pan-y; }
        
        .tab-btn .tab-label {
            display: inline-block; max-width: 0; opacity: 0; overflow: hidden; white-space: nowrap;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); vertical-align: bottom; margin-left: 0;
        }
        .tab-btn:hover .tab-label, .tab-btn:active .tab-label {
            max-width: 100px; opacity: 1; margin-left: 6px;
        }

        /* Scroll Safe Areas - Ensure these allow vertical scrolling */
        .card-scroll-safe { touch-action: pan-y !important; cursor: default; }
        .timeline-left-area { touch-action: pan-y !important; }
	/* === 輸入體驗優化 (Input Experience) === */
        /* 強制手機版輸入框字體 16px，防止 iOS 自動放大導致畫面跑版 */
        @media (max-width: 768px) {
            input, select, textarea { font-size: 16px !important; }
        }
        
        /* 隱藏 Google 地圖 iframe 的無用元素 */
        iframe { pointer-events: auto; }

    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        secondary: '#2F3542',
                        accent: '#1E90FF',
                        route: '#3742fa'
                    }
                }
            }
        }
    </script>
</head>
<body class="text-gray-700">

<div id="app" v-cloak class="relative w-full h-full">
    
    <!-- Background Layer -->
    <div class="app-background" :style="{ backgroundImage: appSettings.bgImage ? `url(${appSettings.bgImage})` : 'none', backgroundColor: '#f0f2f5' }" :class="{ 'has-bg-image': appSettings.bgImage }">
        <div class="app-overlay" :style="overlayStyle"></div>
    </div>
    <div class="app-noise"></div>

    <!-- Pull to Refresh Indicator -->
    <div class="refresh-loader" :class="{ 'visible': isPulling }">
        <div class="bg-white/90 p-2 rounded-full shadow-lg border border-gray-100 backdrop-blur-sm">
            <i class="fas fa-sync-alt text-primary animate-spin-fast" v-if="isRefreshing"></i>
            <i class="fas fa-arrow-down text-primary" v-else :style="{ transform: `rotate(${pullDistance * 2}deg)` }"></i>
        </div>
    </div>

    <!-- Main Container -->
    <div class="app-container" :style="[cssVars, containerTransform]" @touchstart="handleTouchStart" @touchmove="handleTouchMove" @touchend="handleTouchEnd">
    
        <!-- 1. Header -->
        <header class="header-section px-5 pt-5 pb-6 border-b border-white/30">
            <div class="flex justify-between items-start mb-4">
                 <button @click="showSettingsModal = true" class="text-gray-400 hover:text-primary transition-colors p-1">
                    <i class="fas fa-sliders-h text-lg"></i>
                </button>
                <div class="text-center flex-1 mx-4">
                     <div v-if="isEditingTitle" class="flex items-center justify-center">
                        <input ref="titleInput" v-model="tripTitle" @blur="saveTitle" @keyup.enter="saveTitle" type="text" class="w-full text-center text-lg font-bold text-gray-800 border-b-2 border-primary outline-none bg-transparent">
                        <button @click="saveTitle" class="ml-2 text-primary"><i class="fas fa-check"></i></button>
                    </div>
                    <div v-else @click="editTitle" class="group cursor-pointer">
                        <h1 class="text-lg font-bold text-gray-800 flex items-center justify-center gap-2 truncate group-hover:text-primary transition-colors">
                            {{ tripTitle }} 
                            <i class="fas fa-pen text-[10px] text-gray-300 group-hover:text-primary"></i>
                        </h1>
                        <p class="text-[10px] text-gray-500 tracking-wide">{{ totalDays }} 天行程 • 東京</p>
                    </div>
                </div>
                 <button @click="showDayManager = true" class="text-gray-400 hover:text-primary transition-colors p-1">
                    <i class="fas fa-layer-group text-lg"></i>
                </button>
            </div>

            <!-- Integrated Tabs -->
            <div class="flex p-1 bg-gray-100 rounded-xl justify-between">
                <button @click="activeTab = 'itinerary'" :class="['flex-1 py-2 rounded-lg text-lg transition-all flex items-center justify-center tab-btn group', activeTab === 'itinerary' ? 'bg-white text-primary shadow-sm' : 'text-gray-400 hover:bg-white/50']">
                    <i class="fas fa-map-marked-alt"></i> 
                    <span class="text-xs font-bold tab-label">行程規劃</span>
                </button>
                <button @click="activeTab = 'expenses'" :class="['flex-1 py-2 rounded-lg text-lg transition-all flex items-center justify-center tab-btn group', activeTab === 'expenses' ? 'bg-white text-primary shadow-sm' : 'text-gray-400 hover:bg-white/50']">
                    <i class="fas fa-calculator"></i>
                    <span class="text-xs font-bold tab-label">分帳記帳</span>
                </button>
                <button @click="activeTab = 'shopping'" :class="['flex-1 py-2 rounded-lg text-lg transition-all flex items-center justify-center tab-btn group', activeTab === 'shopping' ? 'bg-white text-primary shadow-sm' : 'text-gray-400 hover:bg-white/50']">
                    <i class="fas fa-shopping-basket"></i>
                    <span class="text-xs font-bold tab-label">購物清單</span>
                </button>
                <button @click="activeTab = 'info'" :class="['flex-1 py-2 rounded-lg text-lg transition-all flex items-center justify-center tab-btn group', activeTab === 'info' ? 'bg-white text-primary shadow-sm' : 'text-gray-400 hover:bg-white/50']">
                    <i class="fas fa-info-circle"></i>
                    <span class="text-xs font-bold tab-label">旅遊資訊</span>
                </button>
            </div>
        </header>

        <!-- 2. Main Content -->
        <main class="main-content hide-scroll" ref="mainScroll">
            
            <!-- Tab 1: Itinerary -->
            <div v-if="activeTab === 'itinerary'"> 
                
                <!-- Date Selector (Native Scrolling Enabled) -->
                <!-- 使用 @click.capture 確保點擊事件能觸發，同時保留原生滑動 -->
                <div class="day-selector-container hide-scroll select-none items-center px-1">
                    <div v-for="(day, index) in tripDays" :key="index" @click="currentDayIndex = index"
                        :class="['flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col justify-center items-center cursor-pointer transition-all border shadow-sm backdrop-blur-md pointer-events-auto snap-center', 
                                currentDayIndex === index ? 'bg-primary text-white border-primary shadow-lg scale-105' : 'glass-card text-gray-400 border-white/40 hover:bg-white/80']">
                        <span class="text-[10px] font-medium opacity-80">Day</span>
                        <span class="text-xl font-bold">{{ index + 1 }}</span>
                        <div class="flex gap-0.5 mt-1">
                            <div v-for="n in Math.min(day.items.length, 3)" class="w-1 h-1 rounded-full" :class="currentDayIndex === index ? 'bg-white' : 'bg-gray-300'"></div>
                        </div>
                    </div>
                    <button @click="addDay" class="flex-shrink-0 w-12 h-20 rounded-2xl flex flex-col justify-center items-center glass-card text-gray-400 border border-dashed border-gray-400 hover:text-primary hover:border-primary hover:bg-white/60">
                        <i class="fas fa-plus text-lg"></i>
                    </button>
                </div>

                <!-- Weather Card -->
                <div :class="['w-full rounded-2xl p-4 text-white shadow-lg mb-4 flex justify-between items-center transition-all relative overflow-hidden', getWeatherClass(currentWeather)]">
                    <div class="absolute inset-0 bg-black/10"></div>
                    <div class="flex-1 min-w-0 relative z-10"> 
                        <div class="flex flex-wrap items-center gap-2 mb-2">
                            <i class="fas fa-map-marker-alt text-xs opacity-80"></i>
                            <span class="text-sm font-bold opacity-90">東京</span>
                            <div class="border-l pl-2 ml-1 border-white/30 flex items-center flex-1">
                                <input type="date" v-model="tripDays[currentDayIndex].date" @change="onDateChange(currentDayIndex)" class="weather-date-input bg-transparent text-white text-sm focus:outline-none w-full">
                            </div>
                        </div>
                        <div class="flex items-end gap-3">
                            <span class="text-4xl font-bold">{{ currentWeather.maxTemp }}°</span>
                            <div class="flex flex-col mb-1">
                                <span class="text-xs opacity-80">{{ currentWeather.minTemp }}°</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 mt-2">
                            <p class="text-sm font-medium opacity-90">{{ currentWeather.desc }}</p>
                            <div v-if="currentWeather.rainProb !== null" class="flex items-center gap-1 bg-white/20 px-2 py-0.5 rounded-full text-xs">
                                <i class="fas fa-umbrella text-[10px]"></i>
                                <span>{{ currentWeather.rainProb }}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-5xl opacity-90 pl-2 relative z-10">
                        <i :class="currentWeather.icon"></i>
                    </div>
                </div>

                <!-- Timeline Container -->
                <div class="space-y-0 relative" ref="itineraryContainer">
                    
                    <!-- First Item Travel Calculation -->
                    <div v-if="currentItinerary.length > 0 && infoData.hotels.length > 0" class="relative pl-0 mb-4 group z-0">
                         <div class="flex items-center gap-3 ml-0 mb-2">
                            <div class="flex-none w-12 flex flex-col items-center timeline-left-area">
                                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center border-2 border-white shadow-sm z-10">
                                    <i class="fas fa-bed"></i>
                                </div>
                                <div class="flex-1 w-0.5 bg-gray-200 mt-1"></div>
                            </div>
                            <div class="flex-1 pl-1">
                                <div class="flex items-center gap-2 bg-white/60 backdrop-blur-sm rounded-full px-3 py-1 border border-white/50 shadow-sm w-fit card-scroll-safe">
                                    <div class="flex gap-1 border-r border-gray-300 pr-2 mr-1">
                                        <button @click="setTransportMode(null, currentItinerary[0], 'WALKING')" :class="['w-6 h-6 rounded-full flex items-center justify-center text-[10px] transition-colors', firstItemMode === 'WALKING' ? 'bg-blue-100 text-route font-bold' : 'text-gray-400 hover:text-gray-600']"><i class="fas fa-walking"></i></button>
                                        <button @click="setTransportMode(null, currentItinerary[0], 'TRANSIT')" :class="['w-6 h-6 rounded-full flex items-center justify-center text-[10px] transition-colors', (!firstItemMode || firstItemMode === 'TRANSIT') ? 'bg-blue-100 text-route font-bold' : 'text-gray-400 hover:text-gray-600']"><i class="fas fa-subway"></i></button>
                                        <button @click="setTransportMode(null, currentItinerary[0], 'DRIVING')" :class="['w-6 h-6 rounded-full flex items-center justify-center text-[10px] transition-colors', firstItemMode === 'DRIVING' ? 'bg-blue-100 text-route font-bold' : 'text-gray-400 hover:text-gray-600']"><i class="fas fa-car"></i></button>
                                    </div>
                                    <span class="text-xs font-bold text-gray-700 min-w-[3rem] text-center">{{ formatDuration(firstItemCommute) }}</span>
                                    <a :href="getGoogleMapsDirectionUrl(getSelectedHotelAddress(), currentItinerary[0].location, firstItemMode)" target="_blank" class="w-6 h-6 rounded-full bg-route text-white flex items-center justify-center hover:bg-blue-700 shadow-sm ml-1" title="導航">
                                        <i class="fas fa-location-arrow text-[10px]"></i>
                                    </a>
                                </div>
                                <div class="flex items-center mt-1 ml-2 card-scroll-safe">
                                    <span class="text-[10px] text-gray-400 mr-1">從:</span>
                                    <select v-model="tripDays[currentDayIndex].hotelIndex" @change="updateFirstItemTransport" class="hotel-select text-[10px] text-gray-600 font-bold bg-transparent border-none outline-none max-w-[200px] truncate">
                                        <option v-for="(hotel, idx) in infoData.hotels" :key="idx" :value="idx">{{ hotel.name }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentItinerary.length === 0" class="text-center py-16 text-gray-400 border-2 border-dashed border-gray-300 rounded-xl glass-card card-scroll-safe">
                        <i class="fas fa-map-marked-alt text-5xl mb-3 opacity-20"></i>
                        <p>本日尚無行程</p>
                        <button @click="openAddModal" class="mt-4 text-primary text-sm font-bold hover:underline">新增第一個景點</button>
                    </div>

                    <!-- Draggable List (Transition Group) -->
                    <transition-group name="list" tag="div">
                        <div v-for="(item, idx) in currentItinerary" :key="item.id" 
                             class="relative pl-0 group z-10 draggable-item-container select-none touch-none"
                             :class="{ 'is-being-dragged': dragState.isDragging && dragState.dragIndex === idx }">
                             
                            <div class="flex gap-3">
                                <!-- Number Circle -->
                                <div class="flex-none w-12 flex flex-col items-center timeline-left-area">
                                    <div class="w-8 h-8 rounded-full bg-white border-4 border-primary z-10 shadow-sm flex items-center justify-center mt-4 transition-transform duration-300">
                                        <span class="text-[10px] font-bold text-gray-700">{{ idx + 1 }}</span>
                                    </div>
                                    <!-- Vertical Line -->
                                    <div v-if="idx < currentItinerary.length - 1" class="flex-1 w-0.5 bg-gray-200 my-1"></div>
                                </div>

                                <!-- Card -->
                                <div class="flex-1 glass-card card-scroll-safe rounded-2xl shadow-sm relative overflow-hidden mb-2">
                                    <div class="p-3 border-b border-gray-100/50 flex gap-2">
                                        <!-- Custom Drag Handle -->
                                        <div class="flex flex-col justify-center items-center text-gray-300 px-1 border-r border-gray-100 mr-1 cursor-grab active:cursor-grabbing touch-none"
                                             @touchstart.prevent="startItemDrag($event, idx, item)"
                                             @mousedown.prevent="startItemDrag($event, idx, item)">
                                            <i class="fas fa-grip-lines text-lg"></i>
                                        </div>

                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1 pr-2 min-w-0">
                                                    <h3 class="font-bold text-gray-800 text-base leading-tight mb-1 truncate">{{ item.title }}</h3>
                                                    <div class="flex items-center gap-2 text-xs font-mono flex-wrap">
                                                        <span class="bg-gray-100/80 text-gray-700 px-2 py-0.5 rounded">{{ item.time }}</span>
                                                        <i class="fas fa-arrow-right text-gray-300 text-[10px]"></i>
                                                        <span class="text-gray-400">{{ calculateEndTime(item.time, item.duration) }}</span>
                                                        <span class="text-primary ml-1 font-bold"><i class="fas fa-hourglass-half mr-0.5"></i>{{ item.duration }}m</span>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-1 flex-none">
                                                    <button @click.stop="openMap(item.location)" class="w-7 h-7 rounded-full bg-blue-50/80 text-accent hover:bg-blue-100 flex items-center justify-center transition-colors shadow-sm" title="導航">
                                                        <i class="fas fa-location-arrow text-xs"></i>
                                                    </button>
                                                    <button @click.stop="editItem(item)" class="w-7 h-7 rounded-full bg-gray-50/80 text-gray-400 hover:text-gray-600 flex items-center justify-center transition-colors">
                                                        <i class="fas fa-pen text-xs"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-3 pt-2">
                                        <div class="flex items-center gap-2 mb-1 text-xs text-gray-600">
                                            <i class="fas fa-map-pin text-primary w-3 text-center"></i>
                                            <span class="truncate font-medium">{{ item.location || '未設定地點' }}</span>
                                        </div>
                                        <div v-if="item.note" class="mt-1 relative p-2 pl-3 rounded-lg note-custom text-xs shadow-sm bg-opacity-50" :style="getNoteStyle(item.noteColor)">
                                            <p class="whitespace-pre-wrap leading-relaxed">{{ item.note }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gap Navigation -->
                            <div v-if="idx < currentItinerary.length - 1" class="flex gap-3 mb-1" :class="{'gap-nav-hidden': dragState.isDragging}">
                                <div class="flex-none w-12 flex flex-col items-center timeline-left-area">
                                    <div class="h-full w-0.5 bg-gray-200"></div>
                                </div>
                                <div class="flex-1 pl-1">
                                    <div class="flex flex-col items-start gap-1">
                                        <div class="flex items-center bg-white/60 backdrop-blur-sm rounded-full px-2 py-1 border border-white/50 shadow-sm transition-colors hover:bg-white/80 card-scroll-safe">
                                            <div class="flex items-center gap-1 border-r border-gray-300 pr-2 mr-2">
                                                <button @click="setTransportMode(item, currentItinerary[idx+1], 'WALKING')" :class="['w-7 h-7 rounded-full flex items-center justify-center text-[10px] transition-all', item.mode === 'WALKING' ? 'bg-blue-100 text-route font-bold shadow-inner' : 'text-gray-400 hover:bg-gray-100']"><i class="fas fa-walking"></i></button>
                                                <button @click="setTransportMode(item, currentItinerary[idx+1], 'TRANSIT')" :class="['w-7 h-7 rounded-full flex items-center justify-center text-[10px] transition-all', (!item.mode || item.mode === 'TRANSIT') ? 'bg-blue-100 text-route font-bold shadow-inner' : 'text-gray-400 hover:bg-gray-100']"><i class="fas fa-subway"></i></button>
                                                <button @click="setTransportMode(item, currentItinerary[idx+1], 'DRIVING')" :class="['w-7 h-7 rounded-full flex items-center justify-center text-[10px] transition-all', item.mode === 'DRIVING' ? 'bg-blue-100 text-route font-bold shadow-inner' : 'text-gray-400 hover:bg-gray-100']"><i class="fas fa-car"></i></button>
                                            </div>
                                            
                                            <div class="flex items-center gap-1 mr-2">
                                                <i v-if="item.isCalculating" class="fas fa-spinner animate-spin text-[10px] text-route mr-1"></i>
                                                <div class="relative">
                                                    <input type="number" min="0" :value="Math.floor((item.commuteTime || 0) / 60)" @input="updateCommuteTime(item, $event.target.value, 'h')" class="w-6 bg-transparent text-center text-sm font-bold text-gray-700 outline-none p-0" placeholder="0">
                                                    <span class="text-[10px] text-gray-400 absolute -right-2 top-0.5">h</span>
                                                </div>
                                                <span class="mx-1 text-gray-300"></span>
                                                <div class="relative ml-1">
                                                    <input type="number" min="0" :value="(item.commuteTime || 0) % 60" @input="updateCommuteTime(item, $event.target.value, 'm')" class="w-6 bg-transparent text-center text-sm font-bold text-gray-700 outline-none p-0" placeholder="0">
                                                    <span class="text-[10px] text-gray-400 absolute -right-3 top-0.5">m</span>
                                                </div>
                                            </div>

                                            <a :href="getGoogleMapsDirectionUrl(item.location, currentItinerary[idx+1].location, item.mode)" target="_blank" class="w-7 h-7 rounded-full bg-route text-white flex items-center justify-center hover:bg-blue-700 shadow-sm ml-2" title="Google 導航">
                                                <i class="fas fa-location-arrow text-[10px]"></i>
                                            </a>
                                        </div>
                                        <div v-if="checkOverlap(item, currentItinerary[idx+1])" class="text-[10px] text-red-500 font-bold ml-1 animate-pulse">
                                           ⚠️ 時間重疊
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </transition-group>
                </div>
            </div>

            <!-- Ghost Card (Drag時顯示) -->
            <div v-if="dragState.isDragging && dragState.item" 
                 class="ghost-card-container" 
                 :style="{ top: dragState.y + 'px', left: dragState.x + 'px' }">
                <div class="glass-card rounded-2xl shadow-2xl relative overflow-hidden bg-white/95 backdrop-blur-xl border border-primary/50">
                    <div class="p-3 border-b border-gray-100/50 flex gap-2">
                        <div class="flex flex-col justify-center items-center text-primary px-1 border-r border-gray-100 mr-1">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 pr-2 min-w-0">
                                    <h3 class="font-bold text-gray-800 text-base leading-tight mb-1 truncate">{{ dragState.item.title }}</h3>
                                    <div class="flex items-center gap-2 text-xs font-mono flex-wrap">
                                        <span class="bg-gray-100 text-gray-700 px-2 py-0.5 rounded">{{ dragState.item.time }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Expenses -->
            <div v-if="activeTab === 'expenses'">
                 <div class="bg-gradient-to-br from-gray-800 to-black text-white rounded-2xl p-6 shadow-xl mb-6 relative overflow-hidden card-scroll-safe">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-1">
                            <p class="text-gray-400 text-xs uppercase tracking-wider">總支出</p>
                            <select v-model="displayCurrency" class="bg-white/20 border-none text-white text-xs rounded px-2 py-1 outline-none cursor-pointer font-mono font-bold"><option v-for="curr in currencies" :key="curr" :value="curr">{{ curr }}</option></select>
                        </div>
                        <h2 class="text-4xl font-bold mb-4 font-mono">{{ getCurrencySymbol(displayCurrency) }} {{ Math.round(totalExpenseDisplay).toLocaleString() }}</h2>
                        <div class="flex justify-between items-center border-t border-gray-700 pt-4">
                            <span class="text-sm text-gray-300">{{ getExchangeRateText }}</span>
                            <button @click="showSettlement = true" class="bg-primary hover:opacity-90 px-4 py-1.5 rounded-full text-sm font-bold transition-opacity">結算報表</button>
                        </div>
                    </div>
                </div>
                 <div class="grid grid-cols-4 gap-3 mb-6">
                    <button @click="openAddExpenseModal" class="col-span-3 glass-card border-2 border-dashed border-gray-300 text-gray-500 py-3 rounded-xl font-bold hover:border-primary hover:text-primary transition-colors shadow-sm"><i class="fas fa-plus-circle mr-1"></i> 記帳</button>
                    <button @click="showTravelerModal = true" class="col-span-1 glass-card border border-gray-200 text-gray-500 rounded-xl shadow-sm"><i class="fas fa-users-cog"></i></button>
                </div>
                <div class="space-y-3">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="glass-card p-4 rounded-xl shadow-sm border border-white/50 flex items-start gap-3 card-scroll-safe">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-lg text-gray-500 flex-shrink-0">
                            <i :class="getCategoryIcon(exp.category)"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h4 class="font-bold text-gray-800">{{ exp.title }}</h4>
                                <span class="font-bold text-gray-800 text-sm">≈ {{ getCurrencySymbol(displayCurrency) }}{{ Math.round(convertCurrency(exp.amount, exp.currency, displayCurrency)).toLocaleString() }}</span>
                            </div>
                            <div class="flex justify-between items-end mt-1">
                                <div class="text-xs text-gray-400 flex flex-col gap-0.5">
                                     <div class="flex items-center gap-1">
                                        <i class="far fa-calendar-alt text-[10px]"></i> {{ exp.date }}
                                        <span class="ml-1 border-l pl-2">{{ exp.paymentMethod === 'card' ? '信用卡' : '現金' }}</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <span class="bg-gray-100 px-1 rounded">{{ exp.payer }}</span>
                                        <span>付</span>
                                        <span class="font-bold text-gray-600">{{ getCurrencySymbol(exp.currency) }}{{ Number(exp.amount).toLocaleString() }}</span>
                                    </div>
                                    <div v-if="exp.note" class="text-gray-500 italic mt-0.5"><i class="fas fa-sticky-note mr-1 opacity-50"></i>{{ exp.note }}</div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="openEditExpense(exp)" class="text-xs text-gray-400 hover:text-primary"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteExpense(idx)" class="text-xs text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Shopping List -->
            <div v-if="activeTab === 'shopping'" class="pb-20">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <div v-for="(item, idx) in shoppingList" :key="item.id" 
                         :class="['glass-card shop-card rounded-2xl overflow-hidden relative cursor-pointer card-scroll-safe', item.bought ? 'bought' : '']"
                         @click="editShoppingItem(item)">
                        <div class="shop-img-container">
                            <img :src="item.image || 'https://via.placeholder.com/300x300?text=No+Image'" class="shop-img">
                            <div class="shop-bought-mask">
                                <i class="fas fa-check-circle text-white text-4xl shadow-md"></i>
                            </div>
                        </div>
                        <div class="p-3 bg-white/80 backdrop-blur-sm absolute bottom-0 left-0 w-full border-t border-white/50">
                            <div class="font-bold text-gray-800 text-sm truncate">{{ item.name }}</div>
                            <div class="flex justify-between items-center mt-1">
                                <button @click.stop="deleteShoppingItem(idx)" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt text-xs"></i></button>
                                <div @click.stop="toggleBought(item)" class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center cursor-pointer transition-colors" :class="item.bought ? 'bg-green-500 border-green-500' : 'bg-white'">
                                    <i class="fas fa-check text-white text-xs" v-if="item.bought"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div @click="openShoppingModal" class="glass-card rounded-2xl overflow-hidden flex flex-col items-center justify-center p-6 border-2 border-dashed border-gray-300 cursor-pointer hover:border-primary hover:text-primary transition-colors text-gray-400 aspect-[1/1.25] h-full min-h-[150px]">
                        <i class="fas fa-plus text-3xl mb-2"></i>
                        <span class="text-xs font-bold">新增商品</span>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Information (Optimized for Native Input Experience) -->
            <div v-if="activeTab === 'info'" class="space-y-6 card-scroll-safe pb-24">
                <!-- Flight Info -->
                <section>
                    <h3 class="font-bold text-gray-800 text-lg mb-3 pl-3 border-l-4 border-primary flex items-center">
                        航班資訊
                        <span class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded-full ml-2">Flight</span>
                    </h3>
                    <div class="space-y-4">
                        <!-- Outbound -->
                        <div class="glass-card rounded-2xl p-5 card-scroll-safe ring-1 ring-black/5">
                            <div class="flex items-center gap-2 mb-4 text-primary font-bold border-b border-gray-100 pb-2">
                                <i class="fas fa-plane-departure text-xl"></i> 
                                <span>去程 (Outbound)</span>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">航線</label>
                                    <input v-model="infoData.flights.outbound.code" placeholder="TPE-NRT" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-base font-medium outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder:text-gray-300">
                                </div>
                                <div class="relative">
                                    <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">班次</label>
                                    <input v-model="infoData.flights.outbound.flightNum" placeholder="JX800" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-base font-bold uppercase outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder:text-gray-300">
                                    <button @click="fetchFlightInfo('outbound')" class="absolute right-2 bottom-2 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-primary hover:bg-white rounded-lg transition-all">
                                        <i v-if="loadingFlight === 'outbound'" class="fas fa-spinner animate-spin"></i>
                                        <i v-else class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-end gap-2">
                                <div class="flex-1">
                                    <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">起飛</label>
                                    <input type="time" v-model="infoData.flights.outbound.depTime" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-base font-medium outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all">
                                </div>
                                <div class="pb-4 text-gray-300"><i class="fas fa-arrow-right"></i></div>
                                <div class="flex-1">
                                    <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">抵達</label>
                                    <input type="time" v-model="infoData.flights.outbound.arrTime" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-base font-medium outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all">
                                </div>
                            </div>
                        </div>

                        <!-- Inbound -->
                        <div class="glass-card rounded-2xl p-5 card-scroll-safe ring-1 ring-black/5">
                            <div class="flex items-center gap-2 mb-4 text-blue-500 font-bold border-b border-gray-100 pb-2">
                                <i class="fas fa-plane-arrival text-xl"></i> 
                                <span>回程 (Inbound)</span>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">航線</label>
                                    <input v-model="infoData.flights.inbound.code" placeholder="NRT-TPE" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-base font-medium outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder:text-gray-300">
                                </div>
                                <div class="relative">
                                    <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">班次</label>
                                    <input v-model="infoData.flights.inbound.flightNum" placeholder="JX801" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-base font-bold uppercase outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder:text-gray-300">
                                    <button @click="fetchFlightInfo('inbound')" class="absolute right-2 bottom-2 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-primary hover:bg-white rounded-lg transition-all">
                                        <i v-if="loadingFlight === 'inbound'" class="fas fa-spinner animate-spin"></i>
                                        <i v-else class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-end gap-2">
                                <div class="flex-1">
                                    <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">起飛</label>
                                    <input type="time" v-model="infoData.flights.inbound.depTime" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-base font-medium outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all">
                                </div>
                                <div class="pb-4 text-gray-300"><i class="fas fa-arrow-right"></i></div>
                                <div class="flex-1">
                                    <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">抵達</label>
                                    <input type="time" v-model="infoData.flights.inbound.arrTime" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-base font-medium outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Accommodation Info -->
                <section>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-800 text-lg pl-3 border-l-4 border-primary flex items-center">
                            住宿資訊
                            <span class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded-full ml-2">Hotel</span>
                        </h3>
                        <button @click="addInfoItem('hotels')" class="bg-gray-100 hover:bg-primary hover:text-white text-gray-500 w-8 h-8 rounded-full flex items-center justify-center transition-colors shadow-sm"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                    <div class="space-y-4">
                        <div v-for="(hotel, idx) in infoData.hotels" :key="idx" class="glass-card rounded-2xl p-5 relative group card-scroll-safe ring-1 ring-black/5">
                             <button @click="removeInfoItem('hotels', idx)" class="absolute top-3 right-3 text-gray-300 hover:text-red-400 w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full"><i class="fas fa-times"></i></button>
                             <div class="space-y-4">
                                <div>
                                    <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">飯店名稱</label>
                                    <div class="flex gap-2">
                                        <input v-model="hotel.name" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-base font-bold text-gray-800 outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all" placeholder="輸入名稱">
                                        <button @click="autoFillPlace(hotel, 'hotel')" class="w-12 bg-primary/10 text-primary rounded-xl flex items-center justify-center hover:bg-primary hover:text-white transition-colors flex-shrink-0"><i class="fas fa-magic"></i></button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="relative">
                                        <i class="fas fa-phone text-gray-400 absolute left-4 top-4 text-xs"></i>
                                        <input v-model="hotel.phone" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 pl-10 text-base outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all" placeholder="電話號碼">
                                    </div>
                                    <div class="relative">
                                        <i class="fas fa-map-marker-alt text-gray-400 absolute left-4 top-4 text-xs"></i>
                                        <textarea v-model="hotel.address" rows="2" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 pl-10 text-base outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all resize-none" placeholder="地址"></textarea>
                                        <button v-if="hotel.address" @click="openMap(hotel.address)" class="absolute right-2 bottom-2 w-8 h-8 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center hover:bg-blue-600 hover:text-white transition-colors shadow-sm"><i class="fas fa-location-arrow text-xs"></i></button>
                                    </div>
                                </div>
                             </div>
                        </div>
                    </div>
                </section>

                <!-- Car Rental Info -->
                <section>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-800 text-lg pl-3 border-l-4 border-primary flex items-center">
                            租車資訊
                            <span class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded-full ml-2">Car Rental</span>
                        </h3>
                        <button @click="addInfoItem('cars')" class="bg-gray-100 hover:bg-primary hover:text-white text-gray-500 w-8 h-8 rounded-full flex items-center justify-center transition-colors shadow-sm"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                    <div class="space-y-4">
                        <div v-for="(car, idx) in infoData.cars" :key="idx" class="glass-card rounded-2xl p-5 relative group card-scroll-safe ring-1 ring-black/5">
                             <button @click="removeInfoItem('cars', idx)" class="absolute top-3 right-3 text-gray-300 hover:text-red-400 w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full"><i class="fas fa-times"></i></button>
                             <div class="space-y-4">
                                <div>
                                    <label class="text-[10px] text-gray-400 font-bold ml-1 mb-1 block">租車公司</label>
                                    <div class="flex gap-2">
                                        <input v-model="car.company" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-base font-bold text-gray-800 outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all" placeholder="公司名稱">
                                        <button @click="autoFillPlace(car, 'car')" class="w-12 bg-primary/10 text-primary rounded-xl flex items-center justify-center hover:bg-primary hover:text-white transition-colors flex-shrink-0"><i class="fas fa-magic"></i></button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <input v-model="car.refNo" class="bg-gray-50 border border-gray-200 rounded-xl p-3 text-base outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all" placeholder="預約編號/車型">
                                    <input v-model="car.phone" class="bg-gray-50 border border-gray-200 rounded-xl p-3 text-base outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all" placeholder="電話">
                                </div>
                                <div class="relative">
                                    <i class="fas fa-map-pin text-gray-400 absolute left-4 top-4 text-xs"></i>
                                    <textarea v-model="car.address" rows="2" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 pl-10 text-base outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all resize-none" placeholder="取車/還車地址"></textarea>
                                    <button v-if="car.address" @click="openMap(car.address)" class="absolute right-2 bottom-2 w-8 h-8 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center hover:bg-blue-600 hover:text-white transition-colors shadow-sm"><i class="fas fa-location-arrow text-xs"></i></button>
                                </div>
                             </div>
                        </div>
                    </div>
                </section>

                <!-- Emergency Info -->
                <section>
                    <h3 class="font-bold text-gray-800 text-lg mb-3 pl-3 border-l-4 border-red-500 flex items-center">
                        緊急醫療
                        <span class="text-[10px] bg-red-100 text-red-500 px-2 py-0.5 rounded-full ml-2">SOS</span>
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <a href="tel:110" class="glass-card p-5 rounded-2xl flex flex-col items-center justify-center text-center border-l-4 border-red-500 active:scale-95 transition-transform cursor-pointer hover:bg-red-50 card-scroll-safe shadow-sm">
                            <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mb-2">
                                <i class="fas fa-user-shield text-2xl text-red-500"></i>
                            </div>
                            <span class="text-xs text-gray-500 font-bold mb-1 uppercase tracking-wide">Police</span>
                            <span class="text-3xl font-black text-gray-800 font-mono">110</span>
                        </a>
                        <a href="tel:119" class="glass-card p-5 rounded-2xl flex flex-col items-center justify-center text-center border-l-4 border-red-500 active:scale-95 transition-transform cursor-pointer hover:bg-red-50 card-scroll-safe shadow-sm">
                             <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mb-2">
                                <i class="fas fa-ambulance text-2xl text-red-500"></i>
                            </div>
                            <span class="text-xs text-gray-500 font-bold mb-1 uppercase tracking-wide">Ambulance</span>
                            <span class="text-3xl font-black text-gray-800 font-mono">119</span>
                        </a>
                    </div>
                </section>
            </div>
        </main>

        <!-- Floating Add Button -->
        <button v-if="activeTab === 'itinerary' && !dragState.isDragging" @click="openAddModal" class="absolute bottom-6 right-6 w-14 h-14 bg-primary text-white rounded-full shadow-xl flex items-center justify-center text-xl hover:scale-110 transition-transform z-20">
            <i class="fas fa-plus"></i>
        </button>

    </div>

    <!-- ================= MODALS (Keep existing) ================= -->
    
    <!-- Settings Modal -->
    <div v-if="showSettingsModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">介面與導航設定</h3>
            <div class="space-y-6">
                <div>
                    <label class="block text-xs text-gray-500 mb-2 font-bold uppercase">主題顏色 (Palette)</label>
                    <div class="flex items-center gap-3">
                        <input type="color" v-model="appSettings.themeColor" class="w-10 h-10 rounded-full shadow-sm">
                        <div class="flex gap-2">
                            <button v-for="c in presetColors" :key="c" @click="appSettings.themeColor = c" :style="{background: c}" class="w-8 h-8 rounded-full border-2 border-white shadow-sm ring-1 ring-gray-200"></button>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-2 font-bold uppercase">玻璃擬態效果</label>
                    <div class="space-y-3">
                        <div><div class="flex justify-between text-xs mb-1"><span>模糊 (Blur)</span><span>{{ appSettings.glassBlur }}px</span></div><input type="range" min="0" max="30" v-model="appSettings.glassBlur" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"></div>
                        <div><div class="flex justify-between text-xs mb-1"><span>不透明度</span><span>{{ appSettings.cardOpacity }}%</span></div><input type="range" min="20" max="100" v-model="appSettings.cardOpacity" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-2 font-bold uppercase">背景圖片 (支援模糊預覽)</label>
                    <div class="flex gap-2 mb-2"><input type="file" accept="image/*" @change="handleFileUpload" class="text-xs text-gray-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-primary file:text-white hover:file:bg-red-600"></div>
                    <div class="flex gap-2 mt-2 overflow-x-auto pb-1">
                        <div @click="appSettings.bgImage = ''" class="w-12 h-12 flex-shrink-0 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center cursor-pointer text-xs text-gray-400 bg-gray-50">無</div>
                        <img v-for="img in presetBgs" :key="img" :src="img" @click="appSettings.bgImage = img" class="w-12 h-12 flex-shrink-0 rounded-lg object-cover cursor-pointer border-2 hover:border-primary border-transparent">
                    </div>
                </div>
            </div>
            <button @click="saveSettingsAndReload" class="w-full bg-gray-100 mt-6 py-2 rounded-lg font-bold">儲存並應用</button>
        </div>
    </div>

    <!-- Day Manager Modal (Optimized for Smooth Dragging) -->
    <div v-if="showDayManager" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto" ref="dayManagerModal">
            <h3 class="text-lg font-bold mb-4 flex justify-between items-center">管理天數 <button @click="showDayManager = false" class="text-gray-400 w-8 h-8 rounded-full hover:bg-gray-100"><i class="fas fa-times"></i></button></h3>
            
            <!-- List Container -->
            <div class="mb-4 relative touch-action-none" ref="dayListContainer">
                <transition-group name="list" tag="div" class="space-y-3">
                    <div v-for="(day, index) in tripDays" :key="day.id || index" 
                         :data-index="index"
                         class="draggable-day-item flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100 select-none relative transition-all duration-200"
                         :class="{ 'opacity-30 border-dashed border-gray-300 bg-gray-100': dayDragState.isDragging && dayDragState.dragIndex === index }">
                        
                        <div class="flex items-center gap-3 w-full">
                            <!-- Drag Handle -->
                            <div class="text-gray-300 px-2 py-2 cursor-grab active:cursor-grabbing touch-none"
                                 @touchstart.prevent="startDayDrag($event, index, day)"
                                 @mousedown.prevent="startDayDrag($event, index, day)">
                                <i class="fas fa-bars text-lg"></i>
                            </div>
                            
                            <div class="flex flex-col flex-1">
                                <span class="font-bold text-gray-800 text-sm">Day {{ index + 1 }}</span>
                                <span class="text-xs text-gray-500 font-mono">{{ day.date }}</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 pl-2 border-l border-gray-200 ml-2">
                            <span class="text-[10px] bg-white px-2 py-1 rounded border text-gray-400 whitespace-nowrap">{{ day.items.length }} 景點</span>
                            <button @click.stop="deleteDay(index)" class="w-8 h-8 flex items-center justify-center rounded text-red-400 hover:bg-red-50 hover:text-red-500 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </transition-group>
            </div>

            <button @click="addDay" class="w-full py-3 border border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-gray-50 transition-colors"><i class="fas fa-plus mr-2"></i>新增一天</button>
        </div>
    </div>

    <!-- Day Ghost (Visible when dragging day) -->
    <div v-if="dayDragState.isDragging && dayDragState.item" 
         class="ghost-day-container" 
         :style="{ top: dayDragState.y + 'px', left: dayDragState.x + 'px' }">
        <div class="flex items-center justify-between bg-white p-3 rounded-xl shadow-2xl ring-2 ring-primary border border-primary select-none relative opacity-95">
            <div class="flex items-center gap-3 w-full">
                <div class="text-primary px-2 py-2">
                    <i class="fas fa-bars text-lg"></i>
                </div>
                <div class="flex flex-col flex-1">
                    <span class="font-bold text-gray-800 text-sm">Day {{ dayDragState.dragIndex + 1 }}</span>
                    <span class="text-xs text-gray-500 font-mono">{{ dayDragState.item.date }}</span>
                </div>
            </div>
            <div class="flex items-center gap-2 pl-2 border-l border-gray-200 ml-2">
                <span class="text-[10px] bg-white px-2 py-1 rounded border text-gray-400 whitespace-nowrap">{{ dayDragState.item.items.length }} 景點</span>
                <button class="w-8 h-8 flex items-center justify-center rounded text-red-300">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Itinerary Edit/Add Modal -->
    <div v-if="showItineraryModal" class="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-4">
                <input v-model="form.title" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-primary" placeholder="名稱">
                <div class="flex gap-2">
                    <input v-model="form.time" type="time" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-primary">
                    <div class="flex items-center gap-1 flex-1">
                        <div class="relative flex-1"><input v-model.number="tempDurationH" type="number" min="0" class="w-full bg-gray-50 border rounded-xl p-3 pr-6 text-center" placeholder="0"><span class="absolute right-2 top-3.5 text-xs text-gray-400">時</span></div>
                        <div class="relative flex-1"><input v-model.number="tempDurationM" @blur="validateDuration" type="number" min="0" class="w-full bg-gray-50 border rounded-xl p-3 pr-6 text-center" placeholder="0"><span class="absolute right-2 top-3.5 text-xs text-gray-400">分</span></div>
                    </div>
                </div>
                <input v-model.lazy="form.location" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3" placeholder="地點 (Google Maps)">
                <div v-if="form.location" class="w-full h-32 rounded-xl bg-gray-100 overflow-hidden border border-gray-200"><iframe width="100%" height="100%" frameborder="0" style="border:0" :src="getMapEmbedUrl(form.location)"></iframe></div>
                <div><div class="flex justify-between items-center mb-2"><label class="text-xs text-gray-400">備註 & 顏色</label><div class="flex gap-1"><div class="relative"><input type="color" v-model="form.noteColor" class="w-6 h-6 p-0 border-0 rounded-full overflow-hidden shadow-sm" title="自訂顏色"></div></div></div><textarea v-model="form.note" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-primary mb-2" placeholder="備註..."></textarea></div>
                <div class="flex gap-3 pt-2"><button v-if="isEditing" @click="deleteItem" class="w-12 bg-red-50 text-red-500 rounded-xl hover:bg-red-100"><i class="fas fa-trash"></i></button><button @click="showItineraryModal = false" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">取消</button><button @click="saveItem" class="flex-1 bg-primary text-white py-3 rounded-xl font-bold">儲存</button></div>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div v-if="showExpenseModal" class="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">{{ isEditingExpense ? '編輯' : '新增' }}記帳</h3>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <select v-model="expenseForm.category" class="bg-gray-50 border rounded-xl p-3 text-sm flex-1"><option value="food">🍽️ 飲食</option><option value="transport">🚆 交通</option><option value="stay">🏨 住宿</option><option value="ticket">🎫 門票</option><option value="shopping">🛍️ 購物</option><option value="other">📝 其他</option></select>
                    <input v-model="expenseForm.date" type="date" class="bg-gray-50 border rounded-xl p-3 text-sm font-bold flex-1">
                </div>
                <input v-model="expenseForm.title" class="w-full bg-gray-50 border rounded-xl p-3" placeholder="項目名稱 (例如: 拉麵)">
                <div class="flex gap-2"><select v-model="expenseForm.currency" class="bg-gray-50 border rounded-xl p-3 font-bold"><option v-for="c in currencies" :key="c" :value="c">{{ c }}</option></select><input v-model.number="expenseForm.amount" type="number" class="flex-1 bg-gray-50 border rounded-xl p-3 font-bold" placeholder="金額"></div>
                <div v-if="expenseForm.amount && expenseForm.currency !== 'TWD'" class="text-right text-xs text-gray-500">≈ NT$ {{ Math.round(convertCurrency(expenseForm.amount, expenseForm.currency, 'TWD')).toLocaleString() }}</div>
                <div><label class="text-xs text-gray-400 block mb-2">付款方式</label><div class="flex gap-2"><button @click="expenseForm.paymentMethod = 'cash'" :class="['flex-1 py-2 rounded-lg text-sm border font-bold', expenseForm.paymentMethod === 'cash' ? 'bg-green-50 text-green-600 border-green-200' : 'bg-white text-gray-400']">現金</button><button @click="expenseForm.paymentMethod = 'card'" :class="['flex-1 py-2 rounded-lg text-sm border font-bold', expenseForm.paymentMethod === 'card' ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-white text-gray-400']">信用卡</button></div></div>
                <div><label class="text-xs text-gray-400 block mb-2">誰先付錢？</label><div class="flex gap-2 flex-wrap"><button v-for="p in travelers" :key="p" @click="expenseForm.payer = p" :class="['px-3 py-1.5 rounded-full text-sm border', expenseForm.payer === p ? 'bg-secondary text-white' : 'bg-white']">{{ p }}</button></div></div>
                <div><label class="text-xs text-gray-400 block mb-2">分攤對象</label><div class="flex gap-2 flex-wrap"><button v-for="p in travelers" :key="'inv_'+p" @click="toggleInvolved(p)" :class="['px-3 py-1.5 rounded-full text-sm border flex items-center gap-1', expenseForm.involved.includes(p) ? 'bg-accent text-white' : 'bg-gray-50 text-gray-400']"><i v-if="expenseForm.involved.includes(p)" class="fas fa-check text-[10px]"></i>{{ p }}</button></div></div>
                <textarea v-model="expenseForm.note" class="w-full bg-gray-50 border rounded-xl p-3 h-20 text-sm" placeholder="備註..."></textarea>
                <button @click="saveExpense" class="w-full bg-secondary text-white py-3 rounded-xl font-bold mt-2">儲存</button>
                <button @click="showExpenseModal = false" class="w-full text-gray-400 py-2">取消</button>
            </div>
        </div>
    </div>

    <!-- Shopping Item Modal -->
    <div v-if="showShoppingModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">{{ isEditingShopping ? '編輯商品' : '新增商品' }}</h3>
            <div class="space-y-4">
                <input v-model="shoppingForm.name" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-primary" placeholder="商品名稱">
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:border-primary relative overflow-hidden group">
                    <input type="file" accept="image/*" @change="handleShoppingImageUpload" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                    <div v-if="shoppingForm.image" class="relative w-full h-32"><img :src="shoppingForm.image" class="w-full h-full object-contain"><div class="absolute inset-0 bg-black/30 flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-camera mr-2"></i> 更換</div></div>
                    <div v-else class="text-gray-400 py-4"><i class="fas fa-camera text-3xl mb-2"></i><p class="text-xs">點擊上傳圖片</p></div>
                </div>
                <button @click="saveShoppingItem" class="w-full bg-primary text-white py-3 rounded-xl font-bold">儲存</button>
                <button @click="showShoppingModal = false" class="w-full text-gray-400 py-2">取消</button>
            </div>
        </div>
    </div>

    <!-- Settlement & Travelers Modals -->
   <div v-if="showSettlement" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl flex flex-col max-h-[85vh] relative">
            <h3 class="text-lg font-bold mb-4 text-center flex-none">
                結算建議 <span class="text-sm font-normal text-gray-500 font-mono">({{ displayCurrency }})</span>
            </h3>
            
            <!-- List Area (Scrollable) -->
            <div class="flex-1 min-h-0 overflow-y-auto space-y-2 pr-1">
                <div v-if="settlements.length === 0" class="text-center text-gray-400 py-10 flex flex-col items-center">
                    <i class="fas fa-check-circle text-4xl mb-3 text-green-100"></i>
                    <p class="text-sm">目前無帳務，無須結算</p>
                </div>
                
                <div v-for="(s, i) in settlements" :key="i" class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="flex items-center gap-2 text-sm truncate">
                        <span class="font-bold text-gray-700 bg-white px-2 py-1 rounded shadow-sm whitespace-nowrap">{{ s.from }}</span>
                        <i class="fas fa-arrow-right text-gray-300 text-xs"></i>
                        <span class="font-bold text-gray-700 bg-white px-2 py-1 rounded shadow-sm whitespace-nowrap">{{ s.to }}</span>
                    </div>
                    <span class="font-bold text-primary font-mono whitespace-nowrap ml-2">
                        {{ getCurrencySymbol(displayCurrency) }} {{ Math.round(s.amount).toLocaleString() }}
                    </span>
                </div>
            </div>

            <!-- Footer -->
            <button @click="showSettlement = false" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 mt-4 py-3 rounded-xl font-bold transition-colors flex-none">
                關閉
            </button>
        </div>
    </div>
    <div v-if="showTravelerModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-5 sm:p-6 shadow-2xl relative flex flex-col max-h-[85vh]">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-800 flex-none">
                <i class="fas fa-users text-primary"></i> 旅伴管理
            </h3>
            
            <!-- List Area (可捲動區域) -->
            <div class="space-y-2 mb-4 overflow-y-auto pr-1 flex-1 min-h-0">
                <div v-for="(p, idx) in travelers" :key="idx" class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100 transition-all hover:border-primary/30 shrink-0">
                    <span class="font-bold text-gray-700 ml-1 truncate max-w-[150px]">{{ p }}</span> 
                    <button @click="travelers.splice(idx,1)" v-if="travelers.length>1" class="w-8 h-8 flex-shrink-0 flex items-center justify-center bg-white border border-red-100 text-red-400 rounded-lg hover:bg-red-50 hover:text-red-500 transition-colors shadow-sm">
                        <i class="fas fa-minus text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Input Area (固定底部) -->
            <div class="flex gap-2 items-center pt-4 border-t border-gray-100 flex-none">
                <!-- min-w-0 是關鍵：防止 flex 子元素在小螢幕撐開容器導致跑版 -->
                <input v-model="newTravelerName" @keyup.enter="addTraveler" class="flex-1 min-w-0 bg-gray-50 border border-gray-200 rounded-xl p-3 text-base outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder:text-gray-400" placeholder="輸入名字...">
                <button @click="addTraveler" class="w-12 h-12 flex-shrink-0 bg-primary text-white rounded-xl flex items-center justify-center shadow-lg shadow-primary/30 hover:scale-105 active:scale-95 transition-all">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <button @click="showTravelerModal = false" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 mt-4 py-3 rounded-xl font-bold transition-colors flex-none">
                完成
            </button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // State
            const activeTab = ref('itinerary');
            const tripTitle = ref('我的東京之旅');
            const isEditingTitle = ref(false);
            const titleInput = ref(null);
            const tripDays = ref([{ id: Date.now(), date: new Date().toISOString().split('T')[0], items: [] }]);
            const currentDayIndex = ref(0);
            
            // Info Data
            const infoData = ref({
                flights: {
                    outbound: { code: '', depTime: '', arrTime: '', flightNum: '' },
                    inbound: { code: '', depTime: '', arrTime: '', flightNum: '' }
                },
                hotels: [],
                cars: []
            });

            // Shopping List Data
            const shoppingList = ref([]);
            const showShoppingModal = ref(false);
            const isEditingShopping = ref(false);
            const shoppingForm = ref({ id: null, name: '', image: '', bought: false });

            // Loading state for flight search
            const loadingFlight = ref(null);

            // First item calculation state
            const firstItemCommute = ref(0);
            const firstItemMode = ref('TRANSIT');

            // Pull to Refresh State
            const isPulling = ref(false);
            const isRefreshing = ref(false);
            const pullDistance = ref(0);
            const pullThreshold = 80;
            const startY = ref(0);
            const containerTransform = computed(() => isPulling.value ? { transform: `translateY(${Math.min(pullDistance.value, 100)}px)` } : {});

            // Drag State (Pointer Event Replacement)
            const dragState = ref({
                isDragging: false,
                item: null,
                dragIndex: null,
                y: 0,
                x: 0,
                offsetY: 0,
                offsetX: 0,
                cardHeight: 0
            });
            const itineraryContainer = ref(null);

            // Settings State
            const showSettingsModal = ref(false);
            const appSettings = ref({
                themeColor: '#FF4757',
                bgImage: '',
                glassBlur: 20,
                cardOpacity: 70,
                glassSaturation: 180
            });
            const presetColors = ['#FF4757', '#2ED573', '#1E90FF', '#FFA502', '#3742fa', '#2F3542'];
            const presetBgs = [
                'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=400&q=80',
                'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=400&q=80',
                'https://images.unsplash.com/photo-1528360983277-13d9b152c611?w=400&q=80'
            ];

            const cssVars = computed(() => ({ 
                '--theme-color': appSettings.value.themeColor,
                '--glass-blur': `${appSettings.value.glassBlur}px`,
                '--glass-opacity': appSettings.value.cardOpacity / 100,
                '--glass-saturation': `${appSettings.value.glassSaturation}%`,
                '--card-border': `rgba(255, 255, 255, ${Math.max(0.2, (100 - appSettings.value.cardOpacity) / 100)})`
            }));
            const overlayStyle = computed(() => ({
                background: appSettings.value.bgImage ? `linear-gradient(to bottom, rgba(255,255,255,${(100 - appSettings.value.cardOpacity + 20) / 200}), rgba(255,255,255,${(100 - appSettings.value.cardOpacity) / 100}))` : 'transparent'
            }));

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { appSettings.value.bgImage = e.target.result; };
                    reader.readAsDataURL(file);
                }
            };

            const getNoteStyle = (hex) => {
                if(!hex) hex = '#F59E0B'; 
                const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16);
                return { backgroundColor: `rgba(${r}, ${g}, ${b}, 0.1)`, borderLeftColor: hex, color: `rgba(${r}, ${g}, ${b}, 0.9)` };
            };

            // Enhanced Drag & Drop for Day Manager (Native-like Smoothness)
            const draggingIndex = ref(null);
            const dayListContainer = ref(null);
            
            const dayDragState = ref({
                isDragging: false,
                dragIndex: null,
                item: null, // Copy of the dragged item data for ghost
                y: 0,
                x: 0,
                offsetY: 0,
                offsetX: 0,
                itemHeight: 0
            });

            const startDayDrag = (e, index, item) => {
                const touch = e.touches ? e.touches[0] : e;
                const target = e.target.closest('.draggable-day-item');
                if (!target) return;

                const rect = target.getBoundingClientRect();
                
                dayDragState.value = {
                    isDragging: true,
                    dragIndex: index,
                    item: JSON.parse(JSON.stringify(item)),
                    y: rect.top,
                    x: rect.left,
                    offsetY: touch.clientY - rect.top,
                    offsetX: touch.clientX - rect.left,
                    itemHeight: rect.height + 12 // Height + gap approximation
                };

                window.addEventListener('touchmove', onDayDragMove, { passive: false });
                window.addEventListener('touchend', onDayDragEnd);
                window.addEventListener('mousemove', onDayDragMove);
                window.addEventListener('mouseup', onDayDragEnd);
            };

            const onDayDragMove = (e) => {
                if (!dayDragState.value.isDragging) return;
                
                if(e.cancelable) e.preventDefault(); // Prevent scroll

                const touch = e.touches ? e.touches[0] : e;
                const currentY = touch.clientY;
                const currentX = touch.clientX;

                // Move Ghost
                dayDragState.value.y = currentY - dayDragState.value.offsetY;
                dayDragState.value.x = currentX - dayDragState.value.offsetX;

                // Calculate Swap Logic based on position relative to container
                if (!dayListContainer.value) return;

                const containerRect = dayListContainer.value.getBoundingClientRect();
                const containerScrollTop = dayListContainer.value.parentNode.scrollTop; // Modal body scroll
                
                // Calculate relative Y within the list
                // We use the center of the ghost card for better detection
                const ghostCenterY = currentY - containerRect.top + (dayDragState.value.itemHeight / 2);
                
                // Estimated new index
                let newIndex = Math.floor(ghostCenterY / dayDragState.value.itemHeight);
                newIndex = Math.max(0, Math.min(newIndex, tripDays.value.length - 1));

                if (newIndex !== dayDragState.value.dragIndex) {
                    // Swap Logic
                    const movingItem = tripDays.value[dayDragState.value.dragIndex];
                    tripDays.value.splice(dayDragState.value.dragIndex, 1);
                    tripDays.value.splice(newIndex, 0, movingItem);
                    
                    dayDragState.value.dragIndex = newIndex;
                    
                    if (navigator.vibrate) navigator.vibrate(5);
                }
            };

            const onDayDragEnd = () => {
                dayDragState.value.isDragging = false;
                dayDragState.value.dragIndex = null;
                dayDragState.value.item = null;
                
                window.removeEventListener('touchmove', onDayDragMove);
                window.removeEventListener('touchend', onDayDragEnd);
                window.removeEventListener('mousemove', onDayDragMove);
                window.removeEventListener('mouseup', onDayDragEnd);
                
                onDateChange(0); 
                saveData();
            };

            const weatherData = ref({}); 
            const currencies = ['TWD', 'JPY', 'USD', 'KRW', 'CNY', 'EUR', 'GBP', 'HKD', 'THB', 'AUD'];
            const exchangeRates = ref({ TWD: 1, JPY: 0.21, USD: 32 }); 
            const displayCurrency = ref('TWD'); 

            const showDayManager = ref(false);
            const showItineraryModal = ref(false);
            const isEditing = ref(false);
            const editingId = ref(null);
            const form = ref({});
            const tempDurationH = ref(0);
            const tempDurationM = ref(0);
            const travelers = ref(['我', '旅伴A']);
            const expenses = ref([]);
            const showExpenseModal = ref(false);
            const isEditingExpense = ref(false);
            const editingExpenseId = ref(null);
            const showTravelerModal = ref(false);
            const showSettlement = ref(false);
            const newTravelerName = ref('');
            
            // Expense Form
            const expenseForm = ref({ 
                title: '', amount: '', payer: '我', currency: 'JPY', 
                involved: [], category: 'food', date: '', paymentMethod: 'cash', note: '' 
            });

            // Logic
            const fetchWeather = async () => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo`);
                    weatherData.value = await res.json();
                } catch(e) {}
            };
            const fetchRates = async () => {
                try {
                    const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                    const data = await res.json();
                    if(data && data.rates) {
                        const newRates = { TWD: 1 };
                        for (const [curr, rate] of Object.entries(data.rates)) newRates[curr] = 1 / rate;
                        exchangeRates.value = newRates;
                    }
                } catch(e) {}
            };

            const convertCurrency = (amt, from, to) => (amt * (exchangeRates.value[from] || 1)) / (exchangeRates.value[to] || 1);
            const getCurrencySymbol = (c) => ({ TWD:'NT$', JPY:'¥', USD:'$', KRW:'₩', EUR:'€', GBP:'£', CNY:'¥', HKD:'HK$', THB:'฿', AUD:'A$' }[c] || c);
            const getExchangeRateText = computed(() => displayCurrency.value === 'TWD' ? '基準: TWD (1:1)' : `1 ${displayCurrency.value} ≈ ${(exchangeRates.value[displayCurrency.value]||0).toFixed(3)} TWD`);

            const currentWeather = computed(() => {
                const def = { maxTemp: '--', minTemp: '--', rainProb: null, icon: 'fas fa-cloud', desc: '...', code: -1 };
                if (!weatherData.value.daily) return def;
                const today = tripDays.value[currentDayIndex.value].date;
                const idx = weatherData.value.daily.time.findIndex(t => t === today);
                if (idx === -1) return { maxTemp: '20', minTemp: '15', rainProb: null, icon: 'fas fa-city', desc: '東京平均', code: 999 };
                const code = weatherData.value.daily.weathercode[idx];
                const max = Math.round(weatherData.value.daily.temperature_2m_max[idx]);
                const min = Math.round(weatherData.value.daily.temperature_2m_min[idx]);
                const rain = weatherData.value.daily.precipitation_probability_max ? weatherData.value.daily.precipitation_probability_max[idx] : null;
                let icon = 'fas fa-sun'; let desc = '晴朗';
                if (code <= 1) { icon = 'fas fa-sun'; desc = '晴朗'; } else if (code <= 3) { icon = 'fas fa-cloud-sun'; desc = '多雲'; } else if (code <= 82) { icon = 'fas fa-cloud-rain'; desc = '有雨'; }
                return { maxTemp: max, minTemp: min, rainProb: rain, icon, desc, code };
            });
            const getWeatherClass = (w) => (w.code <= 1 || w.code === 999) ? 'weather-gradient-sunny' : (w.code <= 3 ? 'weather-gradient-cloudy' : 'weather-gradient-rainy');

            onMounted(() => {
                const saved = localStorage.getItem('tokyoTripFinalProPlusMaxPlus2');
                if (saved) {
                    const data = JSON.parse(saved);
                    tripDays.value = data.tripDays || [{ id: Date.now(), date: new Date().toISOString().split('T')[0], items: [] }];
                    
                    // Backfill IDs if missing
                    tripDays.value.forEach((day, idx) => {
                        if (!day.id) day.id = Date.now() + idx;
                    });

                    tripTitle.value = data.tripTitle; 
                    travelers.value = data.travelers; 
                    expenses.value = data.expenses;
                    shoppingList.value = data.shoppingList || [];
                    if(data.infoData) {
                        infoData.value = data.infoData;
                        if(!infoData.value.flights) infoData.value.flights = { outbound: {}, inbound: {} };
                        if(!infoData.value.hotels) infoData.value.hotels = [];
                        if(!infoData.value.cars) infoData.value.cars = [];
                    }
                    if(data.appSettings) {
                        appSettings.value = data.appSettings;
                    }
                } else {
                    tripDays.value[0].id = Date.now();
                }
                fetchWeather(); fetchRates();
            });
            
            const saveSettingsAndReload = () => {
                saveData();
                location.reload(); 
            };

            const saveData = () => { 
                localStorage.setItem('tokyoTripFinalProPlusMaxPlus2', JSON.stringify({ 
                    tripDays: tripDays.value, 
                    tripTitle: tripTitle.value, 
                    travelers: travelers.value, 
                    expenses: expenses.value, 
                    appSettings: appSettings.value,
                    infoData: infoData.value,
                    shoppingList: shoppingList.value
                })); 
            };
            watch([tripDays, tripTitle, travelers, expenses, infoData, shoppingList], saveData, { deep: true });

            // Watchers for Scroll Locking when Modals open
            watch([showSettingsModal, showDayManager, showItineraryModal, showExpenseModal, showShoppingModal, showTravelerModal, showSettlement], (vals) => {
                if (vals.some(v => v)) {
                    document.body.classList.add('scroll-locked');
                } else {
                    document.body.classList.remove('scroll-locked');
                }
            });

            const editTitle = () => { isEditingTitle.value = true; nextTick(() => titleInput.value.focus()); };
            const saveTitle = () => { isEditingTitle.value = false; saveData(); };
            const totalDays = computed(() => tripDays.value.length);
            
            // Updated addDay to include unique ID
            const addDay = () => { 
                const last = tripDays.value[tripDays.value.length - 1]; 
                const d = new Date(last ? last.date : new Date()); 
                d.setDate(d.getDate() + 1); 
                tripDays.value.push({ 
                    id: Date.now(), 
                    date: d.toISOString().split('T')[0], 
                    items: [] 
                }); 
                fetchWeather(); 
            };
            const deleteDay = (i) => { if(tripDays.value.length > 1 && confirm('刪除此日？')) { tripDays.value.splice(i, 1); if(currentDayIndex.value>=tripDays.value.length) currentDayIndex.value--; fetchWeather(); } };
            
            // === Pull to Refresh (Optimized) ===
            const handleTouchStart = (e) => {
                // 1. 僅允許在 Header 區域觸發 (Only allow trigger in Header)
                // 這樣可以避免下方的功能頁面(Itinerary, Expenses等)誤觸
                if (!e.target.closest('.header-section')) return;

                // 2. 確保沒有在滾動狀態 (Ensure not scrolling)
                if (window.scrollY === 0) {
                    startY.value = e.touches[0].clientY;
                    isPulling.value = true;
                }
            };
            const handleTouchMove = (e) => {
                if (!isPulling.value) return;
                const currentY = e.touches[0].clientY;
                const diff = currentY - startY.value;
                if (diff > 0 && window.scrollY === 0) {
                    pullDistance.value = diff * 0.5;
                } else {
                    isPulling.value = false;
                    pullDistance.value = 0;
                }
            };
            const handleTouchEnd = () => {
                if (pullDistance.value > pullThreshold) {
                    isRefreshing.value = true;
                    setTimeout(() => {
                        location.reload();
                    }, 800);
                } else {
                    isPulling.value = false;
                    pullDistance.value = 0;
                }
            };

            // === New Card Drag Logic (Pointer Events) ===
            const startItemDrag = (e, idx, item) => {
                const touch = e.touches ? e.touches[0] : e;
                const rect = e.target.closest('.glass-card').getBoundingClientRect();
                
                dragState.value = {
                    isDragging: true,
                    item: item,
                    dragIndex: idx,
                    y: rect.top,
                    x: rect.left,
                    offsetY: touch.clientY - rect.top,
                    offsetX: touch.clientX - rect.left,
                    cardHeight: rect.height
                };

                window.addEventListener('touchmove', onDragMove, { passive: false });
                window.addEventListener('touchend', onDragEnd);
                window.addEventListener('mousemove', onDragMove);
                window.addEventListener('mouseup', onDragEnd);
            };

            const onDragMove = (e) => {
                if (!dragState.value.isDragging) return;
                e.preventDefault(); 

                const touch = e.touches ? e.touches[0] : e;
                const currentY = touch.clientY;
                const currentX = touch.clientX;

                // Update Ghost
                dragState.value.y = currentY - dragState.value.offsetY;
                dragState.value.x = currentX - dragState.value.offsetX;

                // Swap Logic
                const list = tripDays.value[currentDayIndex.value].items;
                const itemHeight = dragState.value.cardHeight + 10; 
                
                const containerRect = itineraryContainer.value.getBoundingClientRect();
                // Relative Y within the list container
                const relativeY = currentY - containerRect.top + itineraryContainer.value.scrollTop;
                
                let newIndex = Math.floor(relativeY / itemHeight);
                newIndex = Math.max(0, Math.min(newIndex, list.length - 1));

                if (newIndex !== dragState.value.dragIndex) {
                    const movingItem = list[dragState.value.dragIndex];
                    list.splice(dragState.value.dragIndex, 1);
                    list.splice(newIndex, 0, movingItem);
                    dragState.value.dragIndex = newIndex;
                    if (navigator.vibrate) navigator.vibrate(5);
                }
            };

            const onDragEnd = () => {
                if (!dragState.value.isDragging) return;
                
                window.removeEventListener('touchmove', onDragMove);
                window.removeEventListener('touchend', onDragEnd);
                window.removeEventListener('mousemove', onDragMove);
                window.removeEventListener('mouseup', onDragEnd);

                dragState.value.isDragging = false;
                dragState.value.item = null;
                
                updateFirstItemTransport();
                saveData();
            };

            const onDateChange = (i) => { const base = new Date(tripDays.value[i].date); for(let j=i+1; j<tripDays.value.length; j++){ const n = new Date(base); n.setDate(base.getDate()+(j-i)); tripDays.value[j].date = n.toISOString().split('T')[0]; } fetchWeather(); saveData(); };

            const currentItinerary = computed(() => tripDays.value[currentDayIndex.value]?.items || []);

            const openAddModal = () => { isEditing.value = false; form.value = { title: '', time: '09:00', duration: 60, location: '', note: '', noteColor: '#F59E0B', mode: 'TRANSIT', commuteTime: null, id: Date.now() }; tempDurationH.value = 1; tempDurationM.value = 0; showItineraryModal.value = true; };
            const editItem = (item) => { isEditing.value = true; editingId.value = item.id; form.value = { ...item }; tempDurationH.value = Math.floor(item.duration/60); tempDurationM.value = item.duration%60; showItineraryModal.value = true; };
            const validateDuration = () => { if(tempDurationM.value >= 60) { tempDurationH.value += Math.floor(tempDurationM.value/60); tempDurationM.value %= 60; } };
            const saveItem = () => {
                validateDuration(); form.value.duration = (tempDurationH.value||0)*60 + (tempDurationM.value||0);
                const list = tripDays.value[currentDayIndex.value].items;
                if(isEditing.value) { const i = list.findIndex(x => x.id === editingId.value); if(i!==-1) list[i] = { ...form.value }; } else list.push({ ...form.value, id: Date.now() });
                showItineraryModal.value = false;
                updateFirstItemTransport();
            };
            const deleteItem = () => { const list = tripDays.value[currentDayIndex.value].items; const i = list.findIndex(x => x.id === editingId.value); if(i!==-1) list.splice(i, 1); showItineraryModal.value = false; updateFirstItemTransport(); };
            const calculateEndTime = (start, dur) => { if (!start) return ''; const [h, m] = start.split(':').map(Number); const d = new Date(); d.setHours(h, m + parseInt(dur)); return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }); };
            
            // --- Navigation Logic ---
            const getCoords = async (query) => {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ' Tokyo')}&limit=1`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    if(data && data.length > 0) return [parseFloat(data[0].lon), parseFloat(data[0].lat)];
                } catch(e) {}
                return null;
            };
            const getDistance = (lat1, lon1, lat2, lon2) => {
                const R = 6371; const dLat = (lat2-lat1) * Math.PI/180; const dLon = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            };

            const setTransportMode = async (item, nextItem, mode) => { 
                if (item === null) {
                    firstItemMode.value = mode;
                    if(infoData.value.hotels.length > 0 && nextItem && nextItem.location) {
                       const dayHotelIndex = tripDays.value[currentDayIndex.value].hotelIndex || 0;
                       const hotel = infoData.value.hotels[dayHotelIndex] || infoData.value.hotels[0];
                       if(hotel && hotel.address) {
                           const c1 = await getCoords(hotel.address);
                           const c2 = await getCoords(nextItem.location);
                           if(c1 && c2) {
                               const dist = getDistance(c1[1], c1[0], c2[1], c2[0]);
                               let speed = 25; if(mode === 'WALKING') speed = 4.5; if(mode === 'TRANSIT') speed = 30;
                               firstItemCommute.value = Math.ceil((dist / speed) * 60) + (mode === 'TRANSIT' ? 15 : 0);
                           }
                       }
                    }
                    return;
                }

                item.mode = mode; item.isCalculating = true; 
                let calculatedTime = null;

                if (item.location && nextItem.location) {
                    const c1 = await getCoords(item.location);
                    const c2 = await getCoords(nextItem.location);
                    if(c1 && c2) {
                        const dist = getDistance(c1[1], c1[0], c2[1], c2[0]);
                        let speed = 25; 
                        if(mode === 'WALKING') speed = 4.5;
                        if(mode === 'TRANSIT') speed = 30;
                        calculatedTime = Math.ceil((dist / speed) * 60);
                        if(mode === 'TRANSIT') calculatedTime += 15; 
                    }
                }
                if (calculatedTime === null) calculatedTime = 30;
                item.commuteTime = calculatedTime; 
                item.isCalculating = false; 
                saveData();
            };

            const updateFirstItemTransport = async () => {
                if(infoData.value.hotels.length > 0 && currentItinerary.value.length > 0) {
                     await setTransportMode(null, currentItinerary.value[0], firstItemMode.value || 'TRANSIT');
                }
            };
            
            const getSelectedHotelAddress = () => {
                const dayHotelIndex = tripDays.value[currentDayIndex.value].hotelIndex || 0;
                const hotel = infoData.value.hotels[dayHotelIndex] || infoData.value.hotels[0];
                return hotel ? hotel.address : '';
            };

            const updateCommuteTime = (item, val, type) => {
                let h = Math.floor((item.commuteTime||0)/60); let m = (item.commuteTime||0)%60;
                if(type==='h') h=parseInt(val)||0; if(type==='m') m=parseInt(val)||0;
                if(m>=60) { h+=Math.floor(m/60); m%=60; }
                item.commuteTime = h*60+m; saveData();
            };

            const formatDuration = (mins) => {
                if(!mins) return '0m';
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                if (h > 0) return `${h}h ${m}m`;
                return `${m}m`;
            };
            
            const getGoogleMapsDirectionUrl = (o, d, m) => { if(!o || !d) return '#'; return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(o)}&destination=${encodeURIComponent(d)}&travelmode=${m.toLowerCase()||'transit'}`; };
            const openMap = (l) => { if(!l)return; window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l)}`, '_blank'); };
            const getMapEmbedUrl = (l) => `https://maps.google.com/maps?q=${encodeURIComponent(l)}&t=&z=15&ie=UTF8&iwloc=&output=embed`;

            const checkOverlap = (item, nextItem) => {
                if(!item || !nextItem || !item.time || !nextItem.time) return false;
                const getMinutes = (t) => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
                const startA = getMinutes(item.time);
                const durationA = parseInt(item.duration) || 0;
                const commute = parseInt(item.commuteTime) || 0;
                return (startA + durationA + commute) > getMinutes(nextItem.time);
            };

            // Expenses Logic
            const openAddExpenseModal = () => { 
                isEditingExpense.value = false; 
                const defaultDate = tripDays.value[currentDayIndex.value] ? tripDays.value[currentDayIndex.value].date : new Date().toISOString().split('T')[0];
                expenseForm.value = { 
                    title: '', amount: '', payer: '我', currency: 'JPY', involved: [...travelers.value], 
                    id: Date.now(), category: 'food', date: defaultDate, paymentMethod: 'cash', note: ''
                }; 
                showExpenseModal.value = true; 
            };
            const openEditExpense = (e) => { 
                isEditingExpense.value = true; 
                editingExpenseId.value = e.id; 
                expenseForm.value = JSON.parse(JSON.stringify(e)); 
                if(!expenseForm.value.involved) expenseForm.value.involved = [...travelers.value]; 
                if(!expenseForm.value.category) expenseForm.value.category = 'food';
                showExpenseModal.value = true; 
            };
            const toggleInvolved = (p) => { const i = expenseForm.value.involved.indexOf(p); if(i>-1) expenseForm.value.involved.splice(i,1); else expenseForm.value.involved.push(p); };
            const totalExpenseDisplay = computed(() => expenses.value.reduce((s, i) => s + convertCurrency(i.amount, i.currency, displayCurrency.value), 0));
            const saveExpense = () => { if(expenseForm.value.title && expenseForm.value.amount && expenseForm.value.involved.length>0) { if(isEditingExpense.value) { const i = expenses.value.findIndex(e=>e.id===editingExpenseId.value); if(i!==-1) expenses.value[i] = { ...expenseForm.value }; } else { expenses.value.push({ ...expenseForm.value, id: Date.now() }); } showExpenseModal.value = false; } else alert("請填寫完整"); };
            const deleteExpense = (i) => expenses.value.splice(i, 1);
            const addTraveler = () => { if(newTravelerName.value) travelers.value.push(newTravelerName.value); newTravelerName.value=''; };
            
            const getCategoryIcon = (cat) => {
                const icons = { food: 'fas fa-utensils text-orange-400', transport: 'fas fa-train text-blue-500', stay: 'fas fa-bed text-indigo-500', ticket: 'fas fa-ticket-alt text-pink-500', shopping: 'fas fa-shopping-bag text-red-400', other: 'fas fa-sticky-note text-gray-400' };
                return icons[cat] || icons['other'];
            };

            const settlements = computed(() => {
                let debts = {}; travelers.value.forEach(p => { debts[p] = {}; travelers.value.forEach(o => { if(p!==o) debts[p][o] = 0; }); });
                expenses.value.forEach(e => {
                    const amt = convertCurrency(e.amount, e.currency, displayCurrency.value);
                    const inv = (e.involved && e.involved.length>0) ? e.involved : [];
                    if(inv.length>0) {
                        const split = amt/inv.length;
                        inv.forEach(p => { if(p!==e.payer) { if(!debts[p][e.payer]) debts[p][e.payer]=0; debts[p][e.payer]+=split; } });
                    }
                });
                let res = []; let processed = new Set();
                travelers.value.forEach(p1 => {
                    travelers.value.forEach(p2 => {
                        if(p1===p2) return;
                        const key = [p1,p2].sort().join('-');
                        if(processed.has(key)) return;
                        processed.add(key);
                        const a = (debts[p1]&&debts[p1][p2])||0; const b = (debts[p2]&&debts[p2][p1])||0;
                        if(a>b) { const d=a-b; if(d>0.1) res.push({from:p1, to:p2, amount:d}); }
                        else if(b>a) { const d=b-a; if(d>0.1) res.push({from:p2, to:p1, amount:d}); }
                    });
                });
                return res;
            });

            // Shopping Logic
            const openShoppingModal = () => { isEditingShopping.value = false; shoppingForm.value = { id: Date.now(), name: '', image: '', bought: false }; showShoppingModal.value = true; };
            const editShoppingItem = (item) => { isEditingShopping.value = true; shoppingForm.value = { ...item }; showShoppingModal.value = true; };
            const saveShoppingItem = () => {
                if(!shoppingForm.value.name) return;
                if(isEditingShopping.value) { const idx = shoppingList.value.findIndex(i => i.id === shoppingForm.value.id); if(idx !== -1) shoppingList.value[idx] = { ...shoppingForm.value }; } else { shoppingList.value.push({ ...shoppingForm.value }); }
                showShoppingModal.value = false;
            };
            const deleteShoppingItem = (idx) => { if(confirm('確定刪除?')) shoppingList.value.splice(idx, 1); };
            const toggleBought = (item) => { item.bought = !item.bought; };
            const handleShoppingImageUpload = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (e) => shoppingForm.value.image = e.target.result; reader.readAsDataURL(file); } };

            // Info Functions
            const addInfoItem = (type) => { if(type === 'hotels') infoData.value.hotels.push({ name:'', phone:'', address:'' }); if(type === 'cars') infoData.value.cars.push({ company:'', refNo:'', address:'', phone:'' }); };
            const removeInfoItem = (type, idx) => { if(type === 'hotels') infoData.value.hotels.splice(idx, 1); if(type === 'cars') infoData.value.cars.splice(idx, 1); updateFirstItemTransport(); };
            const calculateDuration = (start, end) => { if(!start || !end) return null; const [h1, m1] = start.split(':').map(Number); const [h2, m2] = end.split(':').map(Number); let diff = (h2 * 60 + m2) - (h1 * 60 + m1); if(diff < 0) diff += 24 * 60; const h = Math.floor(diff / 60); const m = diff % 60; return `${h}h ${m}m`; };

            const autoFillPlace = async (item, type) => {
                const query = type === 'hotel' ? item.name : item.company;
                if(!query) return alert('請先輸入名稱');
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query + ' Tokyo')}&format=json&addressdetails=1&limit=1`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    if(data && data.length > 0) { item.address = data[0].display_name; alert('已填入地址！'); updateFirstItemTransport(); } else { alert('找不到相關地址，請確認名稱是否正確。'); }
                } catch(e) { alert('連線錯誤，無法搜尋。'); }
            };

            const fetchFlightInfo = async (direction) => {
                const flightNum = infoData.value.flights[direction].flightNum;
                if(!flightNum) return alert('請輸入航班編號');
                loadingFlight.value = direction;
                await new Promise(r => setTimeout(r, 600)); 
                const target = infoData.value.flights[direction];
                const code = flightNum.toUpperCase().replace(/\s/g, '');
                
                // 2024-2025 亞洲擴大版航線資料庫 (台灣出發/抵達)
                // 格式：TPE(航廈) -> 目的地(航廈)
                const flightDB = {
                    // ==========================================
                    // 🇯🇵 日本 - 東京成田 (NRT)
                    // ==========================================
                    'BR198': { dep: '08:50', arr: '12:55', route: 'TPE(T2)→NRT(T1)' },
                    'BR184': { dep: '07:55', arr: '12:00', route: 'TPE(T2)→NRT(T1)' },
                    'BR196': { dep: '15:20', arr: '19:20', route: 'TPE(T2)→NRT(T1)' },
                    'BR197': { dep: '14:00', arr: '16:50', route: 'NRT(T1)→TPE(T2)' },
                    'BR195': { dep: '20:20', arr: '23:25', route: 'NRT(T1)→TPE(T2)' },
                    'BR183': { dep: '13:00', arr: '15:50', route: 'NRT(T1)→TPE(T2)' },
                    'CI100': { dep: '08:55', arr: '13:15', route: 'TPE(T2)→NRT(T2)' },
                    'CI104': { dep: '12:40', arr: '16:55', route: 'TPE(T2)→NRT(T2)' },
                    'CI108': { dep: '14:30', arr: '18:30', route: 'TPE(T2)→NRT(T2)' },
                    'CI101': { dep: '14:35', arr: '17:40', route: 'NRT(T2)→TPE(T2)' },
                    'CI105': { dep: '17:45', arr: '20:50', route: 'NRT(T2)→TPE(T2)' },
                    'CI109': { dep: '20:00', arr: '22:55', route: 'NRT(T2)→TPE(T2)' },
                    'JX800': { dep: '08:30', arr: '12:30', route: 'TPE(T1)→NRT(T2)' },
                    'JX802': { dep: '11:00', arr: '15:00', route: 'TPE(T1)→NRT(T2)' },
                    'JX804': { dep: '15:00', arr: '19:00', route: 'TPE(T1)→NRT(T2)' },
                    'JX801': { dep: '13:40', arr: '16:45', route: 'NRT(T2)→TPE(T1)' },
                    'JX803': { dep: '16:10', arr: '19:25', route: 'NRT(T2)→TPE(T1)' },
                    'JX805': { dep: '20:10', arr: '23:20', route: 'NRT(T2)→TPE(T1)' },
                    'IT200': { dep: '06:35', arr: '11:00', route: 'TPE(T1)→NRT(T2)' },
                    'IT202': { dep: '14:15', arr: '18:35', route: 'TPE(T1)→NRT(T2)' },
                    'IT201': { dep: '11:50', arr: '15:00', route: 'NRT(T2)→TPE(T1)' },
                    'IT203': { dep: '19:25', arr: '22:35', route: 'NRT(T2)→TPE(T1)' },
                    'JL802': { dep: '10:00', arr: '14:00', route: 'TPE(T2)→NRT(T2)' },
                    'JL809': { dep: '18:00', arr: '21:15', route: 'NRT(T2)→TPE(T2)' },
                    'NH824': { dep: '09:30', arr: '13:40', route: 'TPE(T2)→NRT(T1)' },
                    'NH823': { dep: '18:40', arr: '21:50', route: 'NRT(T1)→TPE(T2)' },
                    'CX450': { dep: '13:00', arr: '17:15', route: 'TPE(T1)→NRT(T2)' },
                    'TR898': { dep: '06:40', arr: '10:45', route: 'TPE(T1)→NRT(T1)' },
                    'MM620': { dep: '02:25', arr: '06:50', route: 'TPE(T1)→NRT(T1)' },

                    // ==========================================
                    // 🇯🇵 日本 - 東京羽田 (HND)
                    // ==========================================
                    'BR192': { dep: '07:30', arr: '11:15', route: 'TSA(T1)→HND(T3)' },
                    'BR190': { dep: '16:15', arr: '19:55', route: 'TSA(T1)→HND(T3)' },
                    'BR191': { dep: '12:40', arr: '15:05', route: 'HND(T3)→TSA(T1)' },
                    'CI220': { dep: '09:00', arr: '12:50', route: 'TSA(T1)→HND(T3)' },
                    'CI222': { dep: '18:25', arr: '22:05', route: 'TSA(T1)→HND(T3)' },
                    'CI221': { dep: '14:30', arr: '16:55', route: 'HND(T3)→TSA(T1)' },
                    'JL096': { dep: '09:10', arr: '13:10', route: 'TSA(T1)→HND(T3)' },
                    'JL098': { dep: '14:20', arr: '18:20', route: 'TSA(T1)→HND(T3)' },
                    'JL097': { dep: '08:35', arr: '11:15', route: 'HND(T3)→TSA(T1)' },
                    'NH852': { dep: '13:30', arr: '17:30', route: 'TSA(T1)→HND(T2)' },
                    'NH851': { dep: '09:20', arr: '11:50', route: 'HND(T2)→TSA(T1)' },
                    'IT216': { dep: '00:10', arr: '04:00', route: 'TPE(T1)→HND(T3)' },
                    'IT217': { dep: '05:00', arr: '07:55', route: 'HND(T3)→TPE(T1)' },
                    'MM860': { dep: '20:50', arr: '00:45', route: 'TPE(T1)→HND(T3)' },

                    // ==========================================
                    // 🇯🇵 日本 - 大阪關西 (KIX)
                    // ==========================================
                    'BR132': { dep: '08:30', arr: '11:55', route: 'TPE(T2)→KIX(T1)' },
                    'BR130': { dep: '12:30', arr: '15:55', route: 'TPE(T2)→KIX(T1)' },
                    'BR178': { dep: '06:30', arr: '09:55', route: 'TPE(T2)→KIX(T1)' },
                    'BR131': { dep: '12:55', arr: '15:05', route: 'KIX(T1)→TPE(T2)' },
                    'CI152': { dep: '09:00', arr: '12:50', route: 'TPE(T2)→KIX(T1)' },
                    'CI156': { dep: '08:10', arr: '11:40', route: 'TPE(T2)→KIX(T1)' },
                    'CI172': { dep: '14:20', arr: '17:45', route: 'TPE(T2)→KIX(T1)' },
                    'CI153': { dep: '14:00', arr: '16:15', route: 'KIX(T1)→TPE(T2)' },
                    'JX820': { dep: '07:40', arr: '11:10', route: 'TPE(T1)→KIX(T1)' },
                    'JX822': { dep: '10:15', arr: '13:45', route: 'TPE(T1)→KIX(T1)' },
                    'JX821': { dep: '12:20', arr: '14:35', route: 'KIX(T1)→TPE(T1)' },
                    'IT210': { dep: '06:40', arr: '10:25', route: 'TPE(T1)→KIX(T1)' },
                    'IT212': { dep: '14:20', arr: '17:45', route: 'TPE(T1)→KIX(T1)' },

                    // ==========================================
                    // 🇯🇵 日本 - 其他城市 (FUK, OKA, CTS, NGO, SDJ, KMJ)
                    // ==========================================
                    // 名古屋 (NGO)
                    'CI154': { dep: '07:30', arr: '11:05', route: 'TPE(T2)→NGO(T1)' },
                    'CI151': { dep: '09:50', arr: '12:15', route: 'NGO(T1)→TPE(T2)' },
                    'CX530': { dep: '11:45', arr: '15:25', route: 'TPE(T1)→NGO(T1)' },
                    'JX838': { dep: '14:40', arr: '18:15', route: 'TPE(T1)→NGO(T1)' },
                    'JX839': { dep: '19:15', arr: '21:50', route: 'NGO(T1)→TPE(T1)' },
                    // 福岡 (FUK)
                    'BR106': { dep: '08:10', arr: '11:15', route: 'TPE(T2)→FUK(Int)' },
                    'BR105': { dep: '12:15', arr: '13:50', route: 'FUK(Int)→TPE(T2)' },
                    'CI110': { dep: '06:50', arr: '09:55', route: 'TPE(T2)→FUK(Int)' },
                    'CI116': { dep: '16:40', arr: '19:55', route: 'TPE(T2)→FUK(Int)' },
                    'JX840': { dep: '10:30', arr: '13:45', route: 'TPE(T1)→FUK(Int)' },
                    'JX841': { dep: '14:45', arr: '16:30', route: 'FUK(Int)→TPE(T1)' },
                    'IT240': { dep: '06:45', arr: '10:05', route: 'TPE(T1)→FUK(Int)' },
                    // 沖繩 (OKA)
                    'BR112': { dep: '06:45', arr: '09:15', route: 'TPE(T2)→OKA(Int)' },
                    'CI120': { dep: '08:05', arr: '10:35', route: 'TPE(T2)→OKA(Int)' },
                    'JX870': { dep: '09:30', arr: '12:05', route: 'TPE(T1)→OKA(Int)' },
                    'IT230': { dep: '06:35', arr: '09:15', route: 'TPE(T1)→OKA(Int)' },
                    // 札幌 (CTS)
                    'BR116': { dep: '09:30', arr: '14:05', route: 'TPE(T2)→CTS(Int)' },
                    'CI130': { dep: '08:35', arr: '13:30', route: 'TPE(T2)→CTS(Int)' },
                    'JX850': { dep: '09:30', arr: '14:05', route: 'TPE(T1)→CTS(Int)' },
                    // 仙台 (SDJ)
                    'JX862': { dep: '11:40', arr: '16:00', route: 'TPE(T1)→SDJ' },
                    'BR118': { dep: '10:05', arr: '14:35', route: 'TPE(T2)→SDJ' },
                    'IT254': { dep: '12:45', arr: '17:00', route: 'TPE(T1)→SDJ' },
                    // 熊本 (KMJ)
                    'JX846': { dep: '07:45', arr: '10:55', route: 'TPE(T1)→KMJ' },
                    'CI194': { dep: '14:30', arr: '17:35', route: 'TPE(T2)→KMJ' },

                    // ==========================================
                    // 🇰🇷 韓國 - 首爾 (ICN/GMP), 釜山 (PUS), 濟州 (CJU)
                    // ==========================================
                    // 仁川 (ICN)
                    'BR170': { dep: '07:30', arr: '10:55', route: 'TPE(T2)→ICN(T1)' },
                    'BR160': { dep: '15:15', arr: '18:45', route: 'TPE(T2)→ICN(T1)' },
                    'CI160': { dep: '07:40', arr: '11:10', route: 'TPE(T1)→ICN(T2)' },
                    'CI162': { dep: '16:25', arr: '19:55', route: 'TPE(T1)→ICN(T2)' },
                    'JX870': { dep: '07:30', arr: '11:00', route: 'TPE(T1)→ICN(T1)' }, // 注意：JX870有時飛OKA，需確認班表，此為韓國線代碼重疊情況，星宇首爾為JX870
                    'KE186': { dep: '12:55', arr: '16:20', route: 'TPE(T1)→ICN(T2)' },
                    'OZ712': { dep: '12:55', arr: '16:30', route: 'TPE(T2)→ICN(T1)' },
                    'IT600': { dep: '06:20', arr: '09:50', route: 'TPE(T1)→ICN(T1)' },
                    // 金浦 (GMP)
                    'BR156': { dep: '09:25', arr: '12:50', route: 'TSA(T1)→GMP(Int)' },
                    'CI260': { dep: '09:20', arr: '12:50', route: 'TSA(T1)→GMP(Int)' },
                    // 釜山 (PUS)
                    'CI188': { dep: '07:40', arr: '11:00', route: 'TPE(T1)→PUS(Int)' },
                    'IT606': { dep: '16:40', arr: '19:55', route: 'TPE(T1)→PUS(Int)' },
                    'BX794': { dep: '13:20', arr: '16:30', route: 'TPE(T1)→PUS(Int)' },
                    'BR179': { dep: '13:30', arr: '16:55', route: 'TPE(T2)→PUS(Int)' },
                    // 濟州 (CJU)
                    'IT654': { dep: '07:15', arr: '10:35', route: 'TPE(T1)→CJU' },
                    'TW688': { dep: '13:55', arr: '17:10', route: 'TPE(T1)→CJU' },

                    // ==========================================
                    // 🇻🇳 越南 - 胡志明(SGN), 河內(HAN), 峴港(DAD)
                    // ==========================================
                    // 胡志明 (SGN)
                    'CI781': { dep: '07:30', arr: '10:00', route: 'TPE(T1)→SGN(T2)' },
                    'CI783': { dep: '14:15', arr: '16:50', route: 'TPE(T1)→SGN(T2)' },
                    'BR391': { dep: '09:10', arr: '11:40', route: 'TPE(T2)→SGN(T2)' },
                    'BR395': { dep: '07:20', arr: '09:45', route: 'TPE(T2)→SGN(T2)' },
                    'JX711': { dep: '08:10', arr: '10:35', route: 'TPE(T1)→SGN(T2)' },
                    'VJ841': { dep: '06:55', arr: '09:20', route: 'TPE(T1)→SGN(T2)' },
                    // 河內 (HAN)
                    'CI791': { dep: '08:25', arr: '10:35', route: 'TPE(T1)→HAN(T2)' },
                    'BR397': { dep: '09:00', arr: '11:05', route: 'TPE(T2)→HAN(T2)' },
                    'JX717': { dep: '08:10', arr: '10:25', route: 'TPE(T1)→HAN(T2)' },
                    // 峴港 (DAD)
                    'JX701': { dep: '06:55', arr: '08:50', route: 'TPE(T1)→DAD(T2)' },
                    'CI789': { dep: '14:30', arr: '16:20', route: 'TPE(T1)→DAD(T2)' },
                    'BR383': { dep: '09:45', arr: '11:40', route: 'TPE(T2)→DAD(T2)' },
                    'IT501': { dep: '06:30', arr: '08:15', route: 'TPE(T1)→DAD(T2)' },

                    // ==========================================
                    // 🇹🇭 泰國 - 曼谷 (BKK/DMK), 清邁 (CNX)
                    // ==========================================
                    // 曼谷蘇凡納布 (BKK)
                    'BR201': { dep: '09:10', arr: '11:50', route: 'TPE(T2)→BKK' },
                    'BR205': { dep: '20:45', arr: '23:30', route: 'TPE(T2)→BKK' },
                    'CI831': { dep: '09:25', arr: '12:10', route: 'TPE(T1)→BKK' },
                    'CI835': { dep: '13:35', arr: '16:25', route: 'TPE(T1)→BKK' },
                    'JX741': { dep: '09:40', arr: '12:40', route: 'TPE(T1)→BKK' },
                    'JX745': { dep: '14:40', arr: '17:35', route: 'TPE(T1)→BKK' },
                    // 曼谷廊曼 (DMK)
                    'IT505': { dep: '15:45', arr: '18:45', route: 'TPE(T1)→DMK(T1)' },
                    'IT506': { dep: '19:45', arr: '00:25', route: 'DMK(T1)→TPE(T1)' },
                    // 清邁 (CNX)
                    'BR257': { dep: '07:15', arr: '10:30', route: 'TPE(T2)→CNX' },
                    'CI851': { dep: '07:50', arr: '11:15', route: 'TPE(T1)→CNX' },
                    'JX751': { dep: '12:50', arr: '16:00', route: 'TPE(T1)→CNX' },

                    // ==========================================
                    // 🇲🇾 馬來西亞 - 吉隆坡 (KUL), 檳城 (PEN)
                    // ==========================================
                    // 吉隆坡 (KUL)
                    'CI721': { dep: '08:50', arr: '13:30', route: 'TPE(T1)→KUL(T1)' },
                    'BR217': { dep: '07:00', arr: '11:45', route: 'TPE(T2)→KUL(T1)' },
                    'JX725': { dep: '07:40', arr: '12:25', route: 'TPE(T1)→KUL(T1)' },
                    'D7373': { dep: '13:05', arr: '18:00', route: 'TPE(T1)→KUL(T2)' }, // AirAsia X
                    // 檳城 (PEN)
                    'CI731': { dep: '09:15', arr: '14:00', route: 'TPE(T1)→PEN' },
                    'JX721': { dep: '12:00', arr: '16:40', route: 'TPE(T1)→PEN' },

                    // ==========================================
                    // 🇵🇭 菲律賓 - 馬尼拉 (MNL), 宿霧 (CEB)
                    // ==========================================
                    // 馬尼拉 (MNL)
                    'CI701': { dep: '07:35', arr: '09:40', route: 'TPE(T1)→MNL(T1)' },
                    'BR271': { dep: '09:10', arr: '11:30', route: 'TPE(T2)→MNL(T1)' },
                    'JX785': { dep: '07:50', arr: '10:10', route: 'TPE(T1)→MNL(T3)' },
                    'PR891': { dep: '09:55', arr: '12:15', route: 'TPE(T1)→MNL(T1)' },
                    // 宿霧 (CEB)
                    'BR281': { dep: '07:10', arr: '10:05', route: 'TPE(T2)→CEB(T2)' },
                    'JX781': { dep: '07:10', arr: '10:05', route: 'TPE(T1)→CEB(T2)' },
                    'CI705': { dep: '08:10', arr: '11:05', route: 'TPE(T1)→CEB(T2)' },

                    // ==========================================
                    // 🇨🇳 🇭🇰 🇲🇴 中港澳 - 香港(HKG), 澳門(MFM), 上海(PVG/SHA)
                    // ==========================================
                    // 香港 (HKG)
                    'BR851': { dep: '08:05', arr: '09:50', route: 'TPE(T2)→HKG(T1)' },
                    'BR855': { dep: '14:10', arr: '15:55', route: 'TPE(T2)→HKG(T1)' },
                    'CI903': { dep: '08:00', arr: '09:55', route: 'TPE(T1)→HKG(T1)' },
                    'CI919': { dep: '16:45', arr: '18:45', route: 'TPE(T1)→HKG(T1)' },
                    'CX494': { dep: '10:20', arr: '12:15', route: 'HKG(T1)→TPE(T1)' },
                    'CX451': { dep: '19:35', arr: '21:30', route: 'TPE(T1)→HKG(T1)' },
                    'JX231': { dep: '08:10', arr: '09:55', route: 'TPE(T1)→HKG(T1)' },
                    // 澳門 (MFM)
                    'JX201': { dep: '08:30', arr: '10:20', route: 'TPE(T1)→MFM' },
                    'JX205': { dep: '18:40', arr: '20:30', route: 'TPE(T1)→MFM' },
                    'IT301': { dep: '06:45', arr: '08:35', route: 'TPE(T1)→MFM' },
                    'NX619': { dep: '09:50', arr: '11:40', route: 'TPE(T1)→MFM' }, // 澳門航空
                    // 上海浦東 (PVG)
                    'BR712': { dep: '10:10', arr: '12:05', route: 'TPE(T2)→PVG(T2)' },
                    'BR722': { dep: '16:30', arr: '18:25', route: 'TPE(T2)→PVG(T2)' },
                    'CI501': { dep: '08:50', arr: '10:50', route: 'TPE(T2)→PVG(T1)' },
                    'CI503': { dep: '16:35', arr: '18:35', route: 'TPE(T2)→PVG(T1)' },
                    // 上海虹橋 (SHA) - 松山出發
                    'BR772': { dep: '14:30', arr: '16:15', route: 'TSA(T1)→SHA(T1)' },
                    'CI201': { dep: '12:30', arr: '14:15', route: 'TSA(T1)→SHA(T1)' },
                    'CA198': { dep: '15:45', arr: '17:40', route: 'TSA(T1)→SHA(T1)' },

                    // ==========================================
                    // 🇸🇬 🇮🇩 新加坡(SIN), 雅加達(CGK)
                    // ==========================================
                    // 新加坡 (SIN)
                    'BR225': { dep: '07:40', arr: '12:10', route: 'TPE(T2)→SIN(T3)' },
                    'CI753': { dep: '08:35', arr: '13:15', route: 'TPE(T1)→SIN(T3)' },
                    'JX771': { dep: '09:05', arr: '13:45', route: 'TPE(T1)→SIN(T1)' },
                    'SQ877': { dep: '14:20', arr: '18:55', route: 'TPE(T2)→SIN(T3)' },
                    // 雅加達 (CGK)
                    'CI761': { dep: '08:45', arr: '13:10', route: 'TPE(T1)→CGK(T3)' },
                    'BR237': { dep: '09:00', arr: '13:20', route: 'TPE(T2)→CGK(T3)' }
                };

                if (flightDB[code]) { 
                    const data = flightDB[code]; 
                    target.code = data.route; 
                    target.depTime = data.dep; 
                    target.arrTime = data.arr; 
                    alert(`搜尋成功：${code} 已自動填入。\n航線：${data.route}`); 
                } else { 
                    alert(`查無此航班資料 (${code})。\n請確認格式 (如 JX800) 或請手動輸入。\n目前已擴充：東北亞、東南亞、中港澳等亞洲主要航線。`); 
                }
                loadingFlight.value = null;
            };

            return {
                activeTab, tripTitle, isEditingTitle, editTitle, saveTitle, titleInput, tripDays, currentDayIndex, totalDays, addDay, deleteDay, showDayManager,
                currentItinerary, showItineraryModal, isEditing, form, openAddModal, editItem, saveItem, deleteItem, openMap, getMapEmbedUrl,
                calculateEndTime, getGoogleMapsDirectionUrl, setTransportMode, updateCommuteTime, travelers, expenses, totalExpenseDisplay, showExpenseModal, showTravelerModal, showSettlement,
                expenseForm, saveExpense, deleteExpense, addTraveler, newTravelerName, settlements, currentWeather, getWeatherClass, onDateChange,
                
                dayDragState, startDayDrag, dayListContainer, // New exports for optimized Day Manager
                draggingIndex, // Keep compatibility
                
                exchangeRates, convertCurrency, getCurrencySymbol, displayCurrency, getExchangeRateText,
                openAddExpenseModal, openEditExpense, toggleInvolved, isEditingExpense, currencies, tempDurationH, tempDurationM, validateDuration, getCategoryIcon,
                showSettingsModal, appSettings, presetColors, presetBgs, cssVars, getNoteStyle, overlayStyle, handleFileUpload, saveSettingsAndReload,
                isPulling, isRefreshing, pullDistance, containerTransform, handleTouchStart, handleTouchMove, handleTouchEnd,
                dragState, startItemDrag, itineraryContainer, 
                infoData, addInfoItem, removeInfoItem, calculateDuration, autoFillPlace, fetchFlightInfo, loadingFlight,
                firstItemCommute, firstItemMode, updateFirstItemTransport, formatDuration, checkOverlap, getSelectedHotelAddress,
                shoppingList, showShoppingModal, isEditingShopping, shoppingForm, openShoppingModal, editShoppingItem, saveShoppingItem, deleteShoppingItem, toggleBought, handleShoppingImageUpload
            };
        }
    }).mount('#app');
</script>
</body>
</html>
